Publicidade/Product ADS

/ (raiz do projeto)
â”œâ”€ index.js                         # Sobe o Express, registra as rotas
â”‚   â””â”€ usa routes/publicidadeRoutes.js
â”‚
â”œâ”€ routes/
â”‚   â”œâ”€ publicidadeRoutes.js         # Rotas HTTP de Product Ads
â”‚   â”‚   â€¢ GET /publicidade          -> abre a tela (view)
â”‚   â”‚   â€¢ GET /api/publicidade/product-ads/campaigns
â”‚   â”‚   â€¢ GET /api/publicidade/product-ads/campaigns/:id/items
â”‚   â”‚   â€¢ GET /api/publicidade/product-ads/metricas-diarias
â”‚   â”‚   â””â”€ chama PublicidadeController
â”‚   â”‚
â”‚   â””â”€ ... (outras rotas)
â”‚
â”œâ”€ controllers/
â”‚   â”œâ”€ PublicidadeController.js     # Camada de controller / API
â”‚   â”‚   â€¢ listarCampanhas(req,res)          -> ProductAdsService.listarCampanhas()
â”‚   â”‚   â€¢ listarItensCampanha(req,res)      -> ProductAdsService.listarItensCampanha()
â”‚   â”‚   â€¢ metricasDiarias(req,res)         -> ProductAdsService.metricasDiarias()
â”‚   â”‚   â””â”€ responde JSON para o front
â”‚   â”‚
â”‚   â””â”€ ... (outros controllers)
â”‚
â”œâ”€ services/
â”‚   â”œâ”€ productAdsService.js         # ğŸ’¥ AQUI estÃ¡ toda a lÃ³gica de Product Ads
â”‚   â”‚   â€¢ urls()                                -> endpoints do ML
â”‚   â”‚   â€¢ withAuth() / prepararAuth()          -> token + chamadas autenticadas
â”‚   â”‚   â€¢ obterAdvertiserId()                  -> pega advertiser da conta
â”‚   â”‚   â€¢ buscarThumbnailsParaItens()         -> ğŸ” busca thumbnails em /items
â”‚   â”‚   â€¢ listarCampanhas()                    -> campanhas agregadas
â”‚   â”‚   â€¢ listarItensCampanha()                -> itens + mÃ©tricas + thumbnail
â”‚   â”‚   â€¢ metricasDiarias()                    -> sÃ©rie diÃ¡ria para grÃ¡fico
â”‚   â”‚   â€¢ exportarItensCampanhaCsv()           -> export CSV
â”‚   â”‚
â”‚   â””â”€ tokenService.js / tokenService/index.js # usado por prepararAuth()/withAuth()
â”‚
â”œâ”€ views/
â”‚   â”œâ”€ publicidade.ejs               # Tela â€œPainel de Product Adsâ€
â”‚   â”‚   â€¢ tabela de ranking de campanhas
â”‚   â”‚   â€¢ tabela de itens da campanha
â”‚   â”‚   â€¢ inclui <script src="/js/publicidade.js">
â”‚   â”‚
â”‚   â””â”€ partials/â€¦                    # (se tiver componentes reaproveitados)
â”‚
â””â”€ public/
    â”œâ”€ js/
    â”‚   â”œâ”€ publicidade.js           # Frontend da tela
    â”‚   â”‚   â€¢ busca /api/publicidade/product-ads/campaigns
    â”‚   â”‚   â€¢ busca /api/publicidade/product-ads/campaigns/:id/items
    â”‚   â”‚   â€¢ aplica filtros, paginaÃ§Ã£o (20 itens por pÃ¡gina)
    â”‚   â”‚   â€¢ monta o HTML das linhas, usando `item.thumbnail`
    â”‚   â”‚   â€¢ (vamos colocar aqui o loading de lista / filtros)
    â”‚   â”‚
    â”‚   â””â”€ helpers/â€¦, outros .js
    â”‚
    â”œâ”€ css/
    â”‚   â”œâ”€ publicidade.css          # (se tiver um CSS especÃ­fico da tela)
    â”‚   â””â”€ main.css / theme.css     # estilos globais
    â”‚
    â””â”€ img/
        â””â”€ ...                      # Ã­cones, placeholders de imagem, etc.


Produtos/Validar dimensÃµes

/ (raiz do projeto)
â”œâ”€ index.js                               # Sobe o Express, registra as rotas e pÃ¡ginas
â”‚   â”œâ”€ usa routes/validarDimensoesRoutes.js      (API)
â”‚   â””â”€ GET /validar-dimensoes                    (view HTML da tela)
â”‚
â”œâ”€ routes/
â”‚   â”œâ”€ validarDimensoesRoutes.js          # Rotas HTTP da feature "Validar DimensÃµes"
â”‚   â”‚   â€¢ POST /api/validar-dimensoes/analisar-item
â”‚   â”‚       -> ValidarDimensoesController.analisarItem()
â”‚   â”‚   â””â”€ (futuro) ex.: /api/validar-dimensoes/verificar-nulos-conta, etc.
â”‚   â”‚
â”‚   â””â”€ ... (outras rotas)
â”‚
â”œâ”€ controllers/
â”‚   â”œâ”€ ValidarDimensoesController.js      # Controller da validaÃ§Ã£o de dimensÃµes
â”‚   â”‚   â€¢ getAccountMeta(res)                    -> pega chave/label da conta atual
â”‚   â”‚   â€¢ getCreds(res)                         -> pega mlCreds do res.locals (authMiddleware)
â”‚   â”‚   â€¢ analisarItem(req,res)
â”‚   â”‚       - valida body.mlb
â”‚   â”‚       - monta opts { mlCreds, accountKey }
â”‚   â”‚       - chama ValidarDimensoesService.analisarUm(mlb, opts)
â”‚   â”‚       - responde JSON:
â”‚   â”‚           { success: true, data: { mlb, raw, height_cm, ... }, account: {...} }
â”‚   â”‚
â”‚   â””â”€ ... (outros controllers)
â”‚
â”œâ”€ services/
â”‚   â”œâ”€ validarDimensoesService.js         # ğŸ’¥ NÃºcleo da lÃ³gica de dimensÃµes
â”‚   â”‚   â€¢ urls()
â”‚   â”‚       - resolve base de `items` via config.urls.items ou padrÃ£o ML
â”‚   â”‚   â€¢ prepararAuthState(options)
â”‚   â”‚       - mesmo padrÃ£o do adAnalysisService
â”‚   â”‚       - usa TokenService.renovarTokenSeNecessario(mlCreds)
â”‚   â”‚       - devolve { token, creds, key }
â”‚   â”‚   â€¢ authFetch(url, init, state)
â”‚   â”‚       - faz fetch com Authorization: Bearer {token}
â”‚   â”‚       - em 401, renova token via TokenService.renovar(state.creds) e tenta de novo
â”‚   â”‚   â€¢ parseDimensions(dimStr)
â”‚   â”‚       - recebe string tipo "9x19x19,500"
â”‚   â”‚       - separa em altura, largura, comprimento, peso (cm / g)
â”‚   â”‚       - devolve { height_cm, width_cm, length_cm, weight_g }
â”‚   â”‚   â€¢ ValidarDimensoesService.analisarUm(mlbId, options)
â”‚   â”‚       - chama /items/{mlbId}
â”‚   â”‚       - lÃª item.shipping.dimensions
â”‚   â”‚       - usa parseDimensions(...)
â”‚   â”‚       - retorna:
â”‚   â”‚           {
â”‚   â”‚             mlb,
â”‚   â”‚             success: true/false,
â”‚   â”‚             status: 'OK' | 'ERRO',
â”‚   â”‚             raw,           // string original do ML
â”‚   â”‚             height_cm,
â”‚   â”‚             width_cm,
â”‚   â”‚             length_cm,
â”‚   â”‚             weight_g,
â”‚   â”‚             message (em caso de erro)
â”‚   â”‚           }
â”‚   â”‚
â”‚   â””â”€ tokenService.js / ml-auth.js       # usados para renovar / obter tokens do ML
â”‚
â”œâ”€ views/
â”‚   â”œâ”€ validar-dimensoes.html             # Tela â€œValidar DimensÃµes (MLB)â€
â”‚   â”‚   â€¢ header com conta atual + botÃ£o "Status" + "Trocar conta"
â”‚   â”‚   â€¢ nav com abas (Dashboard, Produtos, IA & Analytics, etc.)
â”‚   â”‚   â€¢ card "Validar DimensÃµes":
â”‚   â”‚       - input MLB Ãºnico + botÃ£o "Analisar"
â”‚   â”‚       - textarea para lote de MLBs + delay entre requisiÃ§Ãµes
â”‚   â”‚       - barra de progresso (atual / total)
â”‚   â”‚       - tabela de resultados:
â”‚   â”‚           #, MLB, Altura, Largura, Comprimento, Peso, String bruta, Status
â”‚   â”‚       - botÃ£o "Exportar CSV"
â”‚   â”‚   â€¢ inclui:
â”‚   â”‚       <link rel="stylesheet" href="/css/validar-dimensoes.css">
â”‚   â”‚       <script src="/js/validar-dimensoes.js"></script>
â”‚   â”‚
â”‚   â””â”€ ... (outras views: dashboard.html, analise-anuncios.html, etc.)
â”‚
â””â”€ public/
    â”œâ”€ js/
    â”‚   â”œâ”€ validar-dimensoes.js           # Frontend da tela de validaÃ§Ã£o de dimensÃµes
    â”‚   â”‚   â€¢ helpers:
    â”‚   â”‚       - $, qs, qsa
    â”‚   â”‚       - ACCOUNT_LABELS
    â”‚   â”‚       - parseDimensions(dimStr)  // versÃ£o de front, usada pra exibir na tabela/CSV
    â”‚   â”‚   â€¢ estado:
    â”‚   â”‚       - currentAccountKey
    â”‚   â”‚       - resultados[] (lista de itens jÃ¡ analisados)
    â”‚   â”‚   â€¢ conta / token:
    â”‚   â”‚       - carregarContaAtual()     -> /api/account/current
    â”‚   â”‚       - trocarConta()           -> limpa cookie e redireciona /select-conta
    â”‚   â”‚       - abrirModalStatus(), fecharModalStatus()
    â”‚   â”‚       - verificarToken(updateModal)
    â”‚   â”‚       - renovarToken(updateModal)
    â”‚   â”‚   â€¢ comunicaÃ§Ã£o com a API:
    â”‚   â”‚       - fetchDimensoes(mlb)
    â”‚   â”‚           -> POST /api/validar-dimensoes/analisar-item
    â”‚   â”‚           -> trata HTTP != 200, erros de JSON, etc.
    â”‚   â”‚           -> devolve { mlb, raw, error? }
    â”‚   â”‚       - processarLote(mlbs[])
    â”‚   â”‚           -> zera resultados
    â”‚   â”‚           -> laÃ§o chamando fetchDimensoes com delay opcional
    â”‚   â”‚           -> atualiza progresso + tabela
    â”‚   â”‚   â€¢ UI:
    â”‚   â”‚       - renderTabela()
    â”‚   â”‚           -> monta <tbody> com #, MLB, altura, largura, comprimento, peso, raw, status
    â”‚   â”‚       - atualizarProgresso(atual, total)
    â”‚   â”‚       - exportarCSV()
    â”‚   â”‚           -> gera CSV com:
    â”‚   â”‚              MLB;Altura_cm;Largura_cm;Comprimento_cm;Peso_g;Bruto_shipping_dimensions;Status
    â”‚   â”‚   â€¢ eventos:
    â”‚   â”‚       - click em #btn-dim-analisar-um      -> processa um MLB
    â”‚   â”‚       - click em #btn-dim-analisar-lote    -> processa lista de MLBs
    â”‚   â”‚       - click em #btn-dim-download         -> baixa CSV
    â”‚   â”‚       - click em #btn-status               -> abre modal de token e chama verificarToken(true)
    â”‚   â”‚       - click em #account-switch           -> trocarConta()
    â”‚   â”‚       - handlers data-action="verificar-token" / "renovar-token" no modal
    â”‚   â”‚       - listener pra fechar o modal clicando fora
    â”‚   â”‚       - DOMContentLoaded -> carregarContaAtual() + bindEvents()
    â”‚   â”‚
    â”‚   â””â”€ ... outros .js (analise-anuncio.js, ia-analytics-curva-abc.js, etc.)
    â”‚
    â”œâ”€ css/
    â”‚   â”œâ”€ validar-dimensoes.css          # (separado) estilos especÃ­ficos da tela
    â”‚   â”‚   â€¢ layout dos cards
    â”‚   â”‚   â€¢ grid dos inputs
    â”‚   â”‚   â€¢ tabela de resultados
    â”‚   â”‚   â€¢ barra de progresso
    â”‚   â”‚
    â”‚   â”œâ”€ dashboard.css                  # estilos globais (header, abas, etc.)
    â”‚   â””â”€ ... outros CSS
    â”‚
    â””â”€ img/
        â””â”€ ...                            # se tiver Ã­cones/ilustraÃ§Ãµes especÃ­ficas


Produtos EstratÃ©gicos

/ (raiz do projeto)
â”œâ”€ index.js # Sobe o Express, registra as rotas e pÃ¡ginas
â”‚ â”œâ”€ app.use(estrategicosRoutes) # expÃµe /api/estrategicos/*
â”‚ â””â”€ GET /estrategicos # (via HtmlRoutes ou rota direta) abre a tela HTML
â”‚
â”œâ”€ routes/
â”‚ â”œâ”€ estrategicosRoutes.js # Rotas HTTP da feature "Produtos EstratÃ©gicos"
â”‚ â”‚ â€¢ GET /api/estrategicos -> EstrategicosController.list
â”‚ â”‚ â€¢ POST /api/estrategicos -> EstrategicosController.upsert (upsert 1 item)
â”‚ â”‚ â€¢ DELETE /api/estrategicos/:mlb -> EstrategicosController.remove
â”‚ â”‚ â€¢ POST /api/estrategicos/replace -> EstrategicosController.replace (upload CSV)
â”‚ â”‚ â€¢ POST /api/estrategicos/apply -> EstrategicosController.apply (cria promoÃ§Ãµes)
â”‚ â”‚ â””â”€ (opcional futuro) filtros por grupo/lista: ?group=drossi etc.
â”‚ â”‚
â”‚ â””â”€ htmlRoutes.js (ou equivalente)
â”‚ â€¢ GET /estrategicos -> views/estrategicos.html
â”‚
â”œâ”€ controllers/
â”‚ â”œâ”€ EstrategicosController.js # Controller da lista de estratÃ©gicos
â”‚ â”‚ â€¢ getAccountMeta(res) -> pega accountKey + label (res.locals)
â”‚ â”‚ â€¢ list(req,res) -> EstrategicosService.listarPorConta()
â”‚ â”‚ â€¢ upsert(req,res) -> valida body { mlb, name?, percent_default?, ... }
â”‚ â”‚ â€¢ remove(req,res) -> EstrategicosService.removerUm(mlb)
â”‚ â”‚ â€¢ replace(req,res) -> EstrategicosService.replaceLista(items, opts)
â”‚ â”‚ â€¢ apply(req,res) -> EstrategicosService.aplicarPromocoes({ items, promotion_type })
â”‚ â”‚ - monta payload para CriarPromocaoService (DEAL / SMART / PRICE_MATCHING / MARKETPLACE_CAMPAIGN)
â”‚ â”‚ - dispara criaÃ§Ã£o de promoÃ§Ãµes em lote para os MLBs recebidos
â”‚ â”‚ â””â”€ responde sempre JSON: { success, items?, error? }
â”‚ â”‚
â”‚ â””â”€ ... (outros controllers do projeto)
â”‚
â”œâ”€ services/
â”‚ â”œâ”€ estrategicosService.js # ğŸ’¥ NÃºcleo da lÃ³gica de â€œProdutos EstratÃ©gicosâ€
â”‚ â”‚ â€¢ carregarPorConta(accountKey) -> busca/gera lista da conta (DB ou JSON/arquivo)
â”‚ â”‚ â€¢ salvarUm(accountKey, item) -> upsert de Ãºnico MLB
â”‚ â”‚ â€¢ removerUm(accountKey, mlb) -> remove da lista
â”‚ â”‚ â€¢ replaceLista(accountKey, items, opts) -> substitui/mescla lista (upload CSV)
â”‚ â”‚ - se opts.remove_missing === true, apaga os que nÃ£o vierem no arquivo
â”‚ â”‚ â€¢ listarPorConta(accountKey) -> retorna array normalizado:
â”‚ â”‚ { mlb, name, percent_default, percent_cycle, percent_applied, status }[]
â”‚ â”‚ â€¢ aplicarPromocoes({ accountKey, items, promotionType, mlCreds })
â”‚ â”‚ - converte { mlb, percent } em payload de criaÃ§Ã£o de promo
â”‚ â”‚ - usa CriarPromocaoService / PromocoesService para falar com o ML
â”‚ â”‚ - devolve resumo: ok, falha, mensagens de erro por MLB
â”‚ â”‚ â””â”€ (implementaÃ§Ã£o atual pode estar em arquivo Ãºnico ou usando DB/JSON)
â”‚ â”‚
â”‚ â””â”€ outros services (tokenService, CriarPromocaoService, etc.) usados internamente
â”‚
â”œâ”€ views/
â”‚ â”œâ”€ estrategicos.html # Tela â€œProdutos EstratÃ©gicosâ€
â”‚ â”‚ â€¢ header padrÃ£o com barra de conta (ğŸ“¦ API Mercado Livre / Produtos)
â”‚ â”‚ â€¢ seÃ§Ã£o â€œConfiguraÃ§Ã£o do ciclo atualâ€
â”‚ â”‚ - input % padrÃ£o para o ciclo
â”‚ â”‚ - botÃ£o â€œPreencher coluna â€˜% deste cicloâ€™â€
â”‚ â”‚ - select â€œTipo de campanhaâ€ (DEAL, SMART, PRICE_MATCHING, MARKETPLACE_CAMPAIGN)
â”‚ â”‚ - botÃ£o â€œğŸš€ Aplicar promoÃ§Ã£o nos selecionadosâ€
â”‚ â”‚ - barra de progresso #bulkAddProgress (para lote de MLBs)
â”‚ â”‚ â€¢ seÃ§Ã£o â€œLista de produtos estratÃ©gicosâ€
â”‚ â”‚ - resumo #summaryTotal / #summarySelected
â”‚ â”‚ - tabela #tblStrategicos com colunas:
â”‚ â”‚ [âœ“], MLB, Nome, % padrÃ£o, % deste ciclo, % aplicada atualmente, Status, AÃ§Ãµes
â”‚ â”‚ â€¢ painel de lote de MLBs (addMlbsPanel):
â”‚ â”‚ - textarea #txtAddMlbs (um MLB por linha ou separados por vÃ­rgula/espaÃ§o)
â”‚ â”‚ - #addMlbsStatus para feedback
â”‚ â”‚ - botÃµes â€œAdicionar MLBsâ€ / â€œCancelarâ€
â”‚ â”‚ â€¢ painel de upload CSV (uploadPanel):
â”‚ â”‚ - input #fileStrategicos
â”‚ â”‚ - checkbox #chkRemoveMissing (â€œremover itens que nÃ£o estiverem no arquivoâ€)
â”‚ â”‚ - #uploadStatus
â”‚ â”‚ â€¢ inclui:
â”‚ â”‚ <link rel="stylesheet" href="/css/estrategicos.css">
â”‚ â”‚ <script src="/js/account-bar.js" defer></script>
â”‚ â”‚ <script src="/js/estrategicos.js" defer></script>
â”‚ â”‚
â”‚ â””â”€ ... (dashboard.html, publicidade.html, validar-dimensoes.html, etc.)
â”‚
â””â”€ public/
â”œâ”€ js/
â”‚ â”œâ”€ estrategicos.js # Frontend da tela de estratÃ©gicos
â”‚ â”‚ â€¢ helpers: $, qs, fetchJSON, toast, formatPercent
â”‚ â”‚ â€¢ estado: rows[] (lista na memÃ³ria), currentGroup
â”‚ â”‚ â€¢ loadRows() -> GET /api/estrategicos e chama renderTable()
â”‚ â”‚ â€¢ renderTable() -> monta <tbody> com inputs editÃ¡veis e botÃµes Salvar/Excluir
â”‚ â”‚ â€¢ saveRow(mlb) -> POST /api/estrategicos (upsert 1)
â”‚ â”‚ â€¢ deleteRow(mlb) -> DELETE /api/estrategicos/:mlb
â”‚ â”‚ â€¢ painel de lote:
â”‚ â”‚ - openAddMlbsPanel(), closeAddMlbsPanel()
â”‚ â”‚ - handleAddMlbsConfirm()
â”‚ â”‚ Â· lÃª textarea, normaliza MLBs
â”‚ â”‚ Â· mostra barra de progresso bulkAddProgress
â”‚ â”‚ Â· faz POST /api/estrategicos para cada MLB
â”‚ â”‚ Â· atualiza rÃ³tulo X / total
â”‚ â”‚ â€¢ upload CSV:
â”‚ â”‚ - parseCsvToItems(text)
â”‚ â”‚ - handleUploadProcess() -> POST /api/estrategicos/replace
â”‚ â”‚ â€¢ handleFillFromGlobal() -> preenche % deste ciclo para todos os rows
â”‚ â”‚ â€¢ handleApplySelected() -> monta { mlb, percent }[] e POST /api/estrategicos/apply
â”‚ â”‚ â€¢ bindStaticEvents() -> liga todos os botÃµes, selects, checkboxes, textarea, etc.
â”‚ â”‚ â€¢ DOMContentLoaded -> bindStaticEvents() + loadRows()
â”‚ â”‚
â”‚ â””â”€ outros .js globais (account-bar.js, dashboard, etc.)
â”‚
â”œâ”€ css/
â”‚ â”œâ”€ estrategicos.css # Estilos especÃ­ficos da tela
â”‚ â”‚ â€¢ .estrategicos-wrap -> layout interno com o mesmo â€œlookâ€ das outras pÃ¡ginas
â”‚ â”‚ â€¢ .estrategicos-header, .estrategicos-header__actions
â”‚ â”‚ â€¢ .estrategicos-controls, .estrategicos-table-card (cards)
â”‚ â”‚ â€¢ .estrategicos-bulk-add -> painel de lote (textarea + botÃµes)
â”‚ â”‚ â€¢ .bulk-progress, .bulk-progress__bar, .bulk-progress__fill
â”‚ â”‚ â€¢ .status-pill, .status-pill--ok, --pending, --error
â”‚ â”‚ â€¢ ajustes de tabela: .col-mlb, .col-name, .col-percent, .col-actions
â”‚ â”‚
â”‚ â”œâ”€ dashboard.css # estilos globais (header, abas, botÃµes .btn, .card, .table, etc.)
â”‚ â””â”€ ... outros CSS
â”‚
â””â”€ img/
â””â”€ ... # se tiver Ã­cones para a tela (estrela, etc.)

Curva ABC (tempo real via API Mercado Livre)

/ (raiz do projeto)
â”œâ”€ index.js
â”‚ â”œâ”€ Sobe o Express, carrega middlewares globais, etc.
â”‚ â”œâ”€ const analyticsAbcRoutes = require('./routes/analytics-abc-Routes')
â”‚ â”œâ”€ app.use('/api/analytics', analyticsAbcRoutes) â†’ expÃµe:
â”‚ â”‚ â€¢ GET /api/analytics/abc-ml/summary
â”‚ â”‚ â€¢ GET /api/analytics/abc-ml/items
â”‚ â””â”€ Usa tambÃ©m htmlRoutes.js / HtmlController para servir a pÃ¡gina HTML da Curva ABC
â”‚
â”œâ”€ routes/
â”‚ â”œâ”€ analytics-abc-Routes.js â† ğŸ’¥ nÃºcleo da funcionalidade Curva ABC (backend)
â”‚ â”‚ â€¢ GET /abc-ml/summary
â”‚ â”‚ - Agrega pedidos pagos via /orders/search (ML) no intervalo date_fromâ€“date_to
â”‚ â”‚ - Faz classificaÃ§Ã£o ABC por receita ou unidades (classifyABC)
â”‚ â”‚ - Calcula totais, cards de curva A/B/C, ticket mÃ©dio, top5 de cada curva, etc.
â”‚ â”‚
â”‚ â”‚ â€¢ GET /abc-ml/items
â”‚ â”‚ - LÃª parÃ¢metros: datas, contas, mÃ©trica, curva, paginaÃ§Ã£o, ordenaÃ§Ã£o, flags de Ads/Promo/Visitasâ€¦
â”‚ â”‚ - Busca pedidos atÃ© 90 dias antes do date_to para preencher janelas:
â”‚ â”‚ units_7d, units_15d, units_30d, units_40d, units_60d, units_90d
â”‚ â”‚ - Classifica ABC, calcula shares e aplica filtro/ordem/paginaÃ§Ã£o
â”‚ â”‚ - Enriquecimento por item (apenas da pÃ¡gina):
â”‚ â”‚ Â· Ads: fetchAdsMetricsByItems (Product Ads v2 /advertisers + /ads)
â”‚ â”‚ Â· PromoÃ§Ãµes: Central de PromoÃ§Ãµes + /items/{id}/prices
â”‚ â”‚ Â· Visitas: /items/visits (agora 1 item por chamada, com unit=day)
â”‚ â”‚ - Resposta: { page, limit, total, data: [...], ads_debug?, promos_debug?, visits_debug? }
â”‚ â”‚ â€¢ Helpers internos importantes:
â”‚ â”‚ - iterOrders({ token, sellerId, date_from, date_to }) â†’ pagina /orders/search
â”‚ â”‚ - classifyABC(rows, { metric, aCut, bCut }) â†’ marca curve A/B/C e share_cum
â”‚ â”‚ - fetchVisitsForItems(...) â†’ chama /items/visits respeitando limite de 1 id por request
â”‚ â”‚ - fetchAdsMetricsByItems(...) + fetchAdsMetricsSingle(...)
â”‚ â”‚ - fetchPromosByItems(...), fetchPromotionsForItemsBatch(...), enrichWithPromotions(...)
â”‚ â”‚ â€¢ DependÃªncias principais:
â”‚ â”‚ - services/ml-auth.js (via getToken(app, req, accountId))
â”‚ â”‚ - node-fetch / fetch para chamar APIs do Mercado Livre
â”‚ â”‚
â”‚ â”œâ”€ htmlRoutes.js
â”‚ â”‚ â€¢ Rota da pÃ¡gina HTML da Curva ABC, algo como:
â”‚ â”‚ - GET /ia-analytics/curva-abc (ou similar) â†’ HtmlController.curvaAbc
â”‚ â”‚ - Renderiza views/ia-analytics/curva-abc.html
â”‚ â”‚ â€¢ Outras telas (dashboard, criar promoÃ§Ã£o, etc.) tambÃ©m vivem aqui
â”‚ â”‚
â”‚ â””â”€ (demais rotas do projeto: criarPromocaoRoutes, publicidadeRoutes, fullRoutes, etc.)
â”‚
â”œâ”€ controllers/
â”‚ â”œâ”€ HtmlController.js
â”‚ â”‚ â€¢ MÃ©todo responsÃ¡vel por devolver a tela da Curva ABC, por ex.:
â”‚ â”‚ - curvaAbc(req, res)
â”‚ â”‚ Â· carrega informaÃ§Ãµes de conta (res.locals.account, etc.)
â”‚ â”‚ Â· responde com view views/ia-analytics/curva-abc.html
â”‚ â”‚
â”‚ â””â”€ (nÃ£o existe um controller separado â€œCurvaAbcControllerâ€:
â”‚ toda a lÃ³gica da Curva ABC estÃ¡ concentrada em analytics-abc-Routes.js)
â”‚
â”œâ”€ services/
â”‚ â”œâ”€ ml-auth.js
â”‚ â”‚ â€¢ getAccessTokenForAccount(accountKey, req)
â”‚ â”‚ - usado por analytics-abc-Routes.js para obter o token de cada conta (drossi, diplany, etc.)
â”‚ â”‚ - por trÃ¡s, conversa com tokenService, config/accounts.js, etc.
â”‚ â”‚ â€¢ Sem ele, os endpoints da Curva ABC nÃ£o conseguem falar com:
â”‚ â”‚ - /users/me, /orders/search, /items/visits, /advertising/*, /seller-promotions/*, /items/{id}/prices
â”‚ â”‚
â”‚ â”œâ”€ tokenService.js (suporte para renovaÃ§Ã£o de tokens)
â”‚ â””â”€ outros services gerais (adsService, sellerPromotionsService, queueService, etc.)
â”‚ â†’ nÃ£o sÃ£o chamados diretamente pela Curva ABC, porque o arquivo de rotas jÃ¡ chama as APIs do ML â€œna mÃ£oâ€.
â”‚
â”œâ”€ views/
â”‚ â”œâ”€ ia-analytics/
â”‚ â”‚ â””â”€ curva-abc.html â† tela da Curva ABC
â”‚ â”‚ â€¢ Estrutura de pÃ¡gina:
â”‚ â”‚ - Header padrÃ£o com barra de contas (usa account-bar.js)
â”‚ â”‚ - Filtros de: datas, contas, curva (A/B/C/ALL), mÃ©trica (unidades/receita), FULL/all, etc.
â”‚ â”‚ - Cards-resumo (totais, participaÃ§Ã£o das curvas, etc.)
â”‚ â”‚ - Tabela principal com mÃ©tricas de vendas, janelas de dias, Ads, promoÃ§Ãµes e visitas
â”‚ â”‚ â€¢ Includes tÃ­picos:
â”‚ â”‚ - <link rel="stylesheet" href="/css/dashboard.css">
â”‚ â”‚ - <link rel="stylesheet" href="/css/curva-abc.css">
â”‚ â”‚ - <script src="/js/account-bar.js" defer></script>
â”‚ â”‚ - <script src="/js/ia-analytics-curva-abc.js" defer></script>
â”‚ â”‚
â”‚ â””â”€ outras views (dashboard.html, criar-promocao.html, publicidade.html, etc.)
â”‚
â”œâ”€ public/
â”‚ â”œâ”€ js/
â”‚ â”‚ â”œâ”€ ia-analytics-curva-abc.js â† frontend da Curva ABC
â”‚ â”‚ â”‚ â€¢ Faz os requests para:
â”‚ â”‚ â”‚ - GET /api/analytics/abc-ml/summary (cards e top5)
â”‚ â”‚ â”‚ - GET /api/analytics/abc-ml/items?... (tabela principal)
â”‚ â”‚ â”‚ â€¢ MantÃ©m o estado da tela: filtro de datas, conta, curva, mÃ©trica, full/all, include_ads, include_promos, include_visits, pÃ¡gina, ordenaÃ§Ã£oâ€¦
â”‚ â”‚ â”‚ â€¢ Renderiza:
â”‚ â”‚ â”‚ - cards de curva A/B/C e TOTAL
â”‚ â”‚ â”‚ - tabela com colunas: MLB, tÃ­tulo, unidades, receita, % participaÃ§Ã£o,
â”‚ â”‚ â”‚ units_7d/15d/30d/40d/60d/90d, dados de Ads, promo (percentual/source), visitas, etc.
â”‚ â”‚ â”‚ â€¢ Liga eventos de UI (change em filtros, paginaÃ§Ã£o, botÃµes) e atualiza a DOM conforme a resposta da API.
â”‚ â”‚ â”‚ â€¢ Usa account-bar.js para descobrir e exibir a conta ativa.
â”‚ â”‚ â”‚
â”‚ â”‚ â”œâ”€ account-bar.js
â”‚ â”‚ â”‚ â€¢ Componente global da barra de contas (seleÃ§Ã£o de conta Mercado Livre), reutilizado em Curva ABC e demais telas.
â”‚ â”‚ â””â”€ outros JS globais (dashboard.js, criar-promocao.js, etc.)
â”‚ â”‚
â”‚ â”œâ”€ css/
â”‚ â”‚ â”œâ”€ curva-abc.css
â”‚ â”‚ â”‚ â€¢ Estilos especÃ­ficos da tela Curva ABC: layout do wrapper, filtros, cards, tabela, badges de curva, etc.
â”‚ â”‚ â”‚ â€¢ Complementa dashboard.css (botÃµes, cards, grid geral).
â”‚ â”‚ â”œâ”€ dashboard.css
â”‚ â”‚ â””â”€ demais CSS do projeto (criar-promocao, publicidade, etc.)
â”‚ â”‚
â”‚ â””â”€ img/ (se houver Ã­cones ou artes usadas na tela)
â”‚
â””â”€ config/ & utils/
â”œâ”€ config/accounts.js
â”‚ â€¢ Define as contas (drossi, diplany, rossidecorâ€¦) usadas na barra de conta e filtros da Curva ABC.
â”œâ”€ config/config.js
â”‚ â€¢ ConfiguraÃ§Ãµes gerais do app (porta, ambiente, chaves base).
â””â”€ utils/helper.js
â€¢ FunÃ§Ãµes utilitÃ¡rias compartilhadas (formataÃ§Ã£o, etc.) que podem ser usadas pelo front/back.

ExclusÃ£o de AnÃºncios (Ãºnico + lote, com painel de processos)

/ (raiz do projeto)
â”œâ”€ index.js
â”‚ â”œâ€“ Sobe o Express, middlewares globais (express.json, cors, cookieParser, estÃ¡ticos em public/, etc.).
â”‚ â”œâ€“ Aplica ensureAccount (garante conta selecionada) e authMiddleware.
â”‚ â”œâ€“ Carrega e registra as rotas de exclusÃ£o:
â”‚ â”‚ js â”‚ â”‚ const excluirAnuncioRoutes = require('./routes/excluirAnuncioRoutes'); â”‚ â”‚ app.use(excluirAnuncioRoutes); â”‚ â”‚ console.log('âœ… ExcluirAnuncioRoutes carregado'); â”‚ â”‚
â”‚ â”‚ â†’ expÃµe no backend:
â”‚ â”‚ â€¢ DELETE /anuncios/excluir/:mlb_id
â”‚ â”‚ â€¢ POST /anuncios/excluir-lote
â”‚ â”‚ â€¢ GET /anuncios/status-exclusao/:id
â”‚ â”œâ€“ Carrega htmlRoutes.js, que inclui a rota da tela:
â”‚ â”‚ â€¢ GET /excluir-anuncio â†’ envia views/excluir-anuncio.html
â”‚ â””â€“ Logs de inicializaÃ§Ã£o mostram o link:
â”‚ â€¢ http://localhost:PORT/excluir-anuncio - Painel de ExclusÃ£o de AnÃºncios
â”‚
â”œâ”€ routes/
â”‚ â”œâ”€ excluirAnuncioRoutes.js â† ğŸ’¥ nÃºcleo das rotas da feature
â”‚ â”‚ â€¢ DELETE /anuncios/excluir/:mlb_id
â”‚ â”‚ â€“ Encaminha para ExcluirAnuncioController.excluirUnico
â”‚ â”‚ â€¢ POST /anuncios/excluir-lote
â”‚ â”‚ â€“ Encaminha para ExcluirAnuncioController.excluirLote
â”‚ â”‚ â€¢ GET /anuncios/status-exclusao/:id
â”‚ â”‚ â€“ Encaminha para ExcluirAnuncioController.status
â”‚ â”‚ â€¢ Essa rota nÃ£o tem prefixo /api, segue o mesmo padrÃ£o de /remover-promocao.
â”‚ â”‚
â”‚ â”œâ”€ htmlRoutes.js
â”‚ â”‚ â€¢ Inclui a rota da interface:
â”‚ â”‚ â€“ GET /excluir-anuncio â†’ envia views/excluir-anuncio.html
â”‚ â”‚ â€¢ Reaproveita o mesmo layout/cabeÃ§alho (account-bar, nav, etc.) das outras telas.
â”‚ â”‚
â”‚ â””â”€ (demais rotas: removerPromocaoRoutes, criarPromocaoRoutes, publicidadeRoutes, etc.)
â”‚
â”œâ”€ controllers/
â”‚ â”œâ”€ ExcluirAnuncioController.js
â”‚ â”‚ â€¢ excluirUnico(req, res)
â”‚ â”‚ â€“ LÃª mlb_id de req.params.mlb_id (ou req.body.mlb_id como fallback).
â”‚ â”‚ â€“ Valida padrÃ£o MLB\d+.
â”‚ â”‚ â€“ Chama ExclusaoService.excluirUnico(mlbId).
â”‚ â”‚ â€“ Retorna o objeto completo do service (incluindo success, message, steps, etc.).
â”‚ â”‚ â€“ Usa statusCode = resultado.success ? 200 : 400.
â”‚ â”‚
â”‚ â”‚ â€¢ excluirLote(req, res)
â”‚ â”‚ â€“ Espera body: { mlb_ids: [...], delay_entre_remocoes? }.
â”‚ â”‚ â€“ Cria um processId e registra em processosExclusao[processId] um snapshot com:
â”‚ â”‚ { id, status, total_anuncios, processados, sucessos, erros, progresso, iniciado_em, resultados }.
â”‚ â”‚ â€“ Responde imediatamente: { success: true, message, process_id }.
â”‚ â”‚ â€“ Dispara em segundo plano ExclusaoService.excluirLote(mlb_ids, processId, statusRef, delay) (sem await).
â”‚ â”‚
â”‚ â”‚ â€¢ status(req, res)
â”‚ â”‚ â€“ LÃª req.params.id e retorna processosExclusao[id] ou 404 se nÃ£o existir.
â”‚ â”‚
â”‚ â””â”€ (demais controllers: HtmlController, etc.)
â”‚
â”œâ”€ services/
â”‚ â”œâ”€ excluirAnuncioService.js â† lÃ³gica de integraÃ§Ã£o com a API do Mercado Livre
â”‚ â”‚ Constantes:
â”‚ â”‚ â€¢ urls.items = https://api.mercadolibre.com/items
â”‚ â”‚ â€¢ urls.me = https://api.mercadolibre.com/users/me
â”‚ â”‚
â”‚ â”‚ Helpers internos:
â”‚ â”‚ â€¢ delay(ms) â€“ pausa entre exclusÃµes no lote.
â”‚ â”‚ â€¢ prepararState(options?) â€“ junta credenciais (APP_ID, CLIENT_SECRET, REFRESH_TOKEN, ACCESS_TOKEN)
â”‚ â”‚ com as opÃ§Ãµes e chama TokenService.renovarTokenSeNecessario, retornando { token, creds }.
â”‚ â”‚ â€¢ authFetch(url, init, state) â€“ faz fetch com Authorization: Bearer <token>,
â”‚ â”‚ e se tomar 401 renova o token com TokenService.renovarToken(state.creds) e tenta de novo.
â”‚ â”‚
â”‚ â”‚ â€¢ async excluirUnico(mlbId, authState?)
â”‚ â”‚ â€“ state = authState || prepararState() (reaproveitÃ¡vel em lote).
â”‚ â”‚ â€“ GET /items/:id â†’ carrega o anÃºncio.
â”‚ â”‚ â€“ GET /users/me â†’ confirma que item.seller_id === me.id.
â”‚ â”‚ â€“ Registra steps com { step: 'item_carregado', status: item.status, seller_id }, etc.
â”‚ â”‚ â€“ Se item.status !== 'closed':
â”‚ â”‚ Â· faz PUT /items/:id com { status: 'closed' }
â”‚ â”‚ Â· adiciona step fechado_sucesso ou erro_ao_fechar.
â”‚ â”‚ â€“ Em seguida, tenta exclusÃ£o definitiva (segundo passo da documentaÃ§Ã£o ML):
â”‚ â”‚ Â· PUT /items/:id com { deleted: true }
â”‚ â”‚ Â· Se ok: retorna { success: true, message: 'AnÃºncio excluÃ­do com sucesso', mlb_id, status_inicial, status_tentado: 'closed', steps, detalhes_ml? }.
â”‚ â”‚ Â· Se 4xx/5xx: retorna { success: false, error: true, message: 'Erro ao excluir anÃºncio: HTTP X â€” ...', detalhes_ml: <body bruto>, ... }.
â”‚ â”‚ â€“ Em casos onde a API jÃ¡ nÃ£o permite exclusÃ£o (anÃºncios com vendas / histÃ³ricos), o service devolve um texto explicativo (como vocÃª viu no JSON).
â”‚ â”‚
â”‚ â”‚ â€¢ async excluirLote(mlbIds, processoId, statusRef, delayEntre)
â”‚ â”‚ â€“ Usa um Ãºnico state com token compartilhado para todos os itens.
â”‚ â”‚ â€“ Para cada mlbId:
â”‚ â”‚ Â· chama excluirUnico(id, state)
â”‚ â”‚ Â· empurra o resultado em statusRef.resultados.
â”‚ â”‚ Â· incrementa statusRef.sucessos ou statusRef.erros.
â”‚ â”‚ Â· incrementa statusRef.processados e statusRef.progresso (processados / total_anuncios * 100).
â”‚ â”‚ Â· aguarda delayEntre ms entre um e outro (quando nÃ£o Ã© o Ãºltimo).
â”‚ â”‚ â€“ Ao final: statusRef.status = 'concluido'; statusRef.concluido_em = new Date();
â”‚ â”‚
â”‚ â”œâ”€ tokenService.js
â”‚ â”‚ â€¢ usado por prepararState/authFetch para renovar tokens.
â”‚ â”‚
â”‚ â””â”€ outros services gerais (ml-auth, queueService, etc.) â€“ nÃ£o participam diretamente da exclusÃ£o,
â”‚ porque aqui a chamada Ã  API do ML Ã© â€œna mÃ£oâ€ via fetch.
â”‚
â”œâ”€ views/
â”‚ â”œâ”€ excluir-anuncio.html â† tela da ExclusÃ£o de AnÃºncios
â”‚ â”‚ â€¢ Reaproveita a moldura padrÃ£o:
â”‚ â”‚ â€“ <link rel="stylesheet" href="/css/dashboard.css">
â”‚ â”‚ â€“ <link rel="stylesheet" href="/css/excluir-anuncio.css?v=2">
â”‚ â”‚ â€“ <link rel="stylesheet" href="/css/promo-jobs.css"> (mesmo painel de processos da Remover PromoÃ§Ãµes)
â”‚ â”‚ â€¢ Layout:
â”‚ â”‚ â€“ header.account-bar com conta atual + botÃ£o Status + Trocar Conta.
â”‚ â”‚ â€“ nav.main-nav com tabs (Dashboard, Produtos, IA & Analytics, etc.); marca â€œProdutosâ€ como ativo.
â”‚ â”‚ â€“ <main class="page-wrap"> â†’ <div class="container"> com:
â”‚ â”‚ Â· <h1>ğŸ—‘ï¸ ExclusÃ£o de AnÃºncios</h1>
â”‚ â”‚ Â· form-group para MLB Ãºnico (#mlb-id).
â”‚ â”‚ Â· form-group para lista de MLBs (#mlb-list).
â”‚ â”‚ Â· div.buttons-row com:
â”‚ â”‚ * #btn-excluir (Excluir Ãšnico)
â”‚ â”‚ * #btn-excluir-lote (Excluir em Lote)
â”‚ â”‚ * #btn-limpar (Limpar)
â”‚ â”‚ Â· #result-panel.result-panel.hidden + <pre id="result-json">{}</pre>.
â”‚ â”‚ â€¢ No fim da pÃ¡gina:
â”‚ â”‚ â€“ <div id="bulkJobsPanel" class="jobs-panel"></div> (painel flutuante de processos).
â”‚ â”‚ â€“ Scripts globais de conta + modal de status + jobs:
â”‚ â”‚ Â· /js/jobs-panel.js
â”‚ â”‚ Â· /js/exclusao-bulk.js
â”‚ â”‚ Â· /js/excluir-anuncio.js
â”‚ â”‚
â”‚ â””â”€ demais views (dashboard, remover-promocao, publicidade, etc.)
â”‚
â”œâ”€ public/js/
â”‚ â”œâ”€ excluir-anuncio.js â† frontend da tela de exclusÃ£o
â”‚ â”‚ â€¢ Seletores: #mlb-id, #mlb-list, #btn-excluir, #btn-excluir-lote, #btn-limpar, #result-panel, #result-json.
â”‚ â”‚ â€¢ showResult(data) â€“ mostra JSON formatado no panel.
â”‚ â”‚ â€¢ limparTudo() â€“ limpa inputs, esconde painel.
â”‚ â”‚ â€¢ excluirUnico()
â”‚ â”‚ â€“ Valida MLB (/^MLB\d{5,}$/).
â”‚ â”‚ â€“ Faz DELETE /anuncios/excluir/:mlb.
â”‚ â”‚ â€“ Exibe o JSON retornado pelo service (incluindo steps).
â”‚ â”‚ â€¢ excluirLote()
â”‚ â”‚ â€“ Quebra textarea em linhas, limpa e de-duplica.
â”‚ â”‚ â€“ Chama ExclusaoBulk.enqueue({ items: lista, delayMs: 250, title: 'ExclusÃ£o em lote (N)' }).
â”‚ â”‚ â€“ Mostra { ok: true, message: 'Enviado para processamento em segundo plano.' }.
â”‚ â”‚ â€¢ Faz o addEventListener('click', ...) nos botÃµes.
â”‚ â”‚
â”‚ â”œâ”€ exclusao-bulk.js â† orquestrador de fila no front (versÃ£o para exclusÃ£o)
â”‚ â”‚ â€¢ MantÃ©m QUEUE e running para nÃ£o rodar mÃºltiplos loops.
â”‚ â”‚ â€¢ enqueue({ items, delayMs, title })
â”‚ â”‚ â€“ limpa/valida lista de MLBs.
â”‚ â”‚ â€“ empilha em QUEUE e dispara pump().
â”‚ â”‚ â€¢ pump()
â”‚ â”‚ â€“ enquanto houver itens na fila, chama startJob(entry).
â”‚ â”‚ â€¢ startJob(entry)
â”‚ â”‚ â€“ Descobre a conta ativa (/api/account/current ou window.__ACCOUNT__).
â”‚ â”‚ â€“ Cria um job local no JobsPanel.addLocalJob({ title: 'ExclusÃ£o â€“ N itens', accountKey/accountLabel }).
â”‚ â”‚ â€“ Chama POST /anuncios/excluir-lote com { mlb_ids, delay_entre_remocoes }.
â”‚ â”‚ â€“ Se success:
â”‚ â”‚ Â· pega process_id
â”‚ â”‚ Â· faz polling em GET /anuncios/status-exclusao/:id a cada 2.5s
â”‚ â”‚ Â· atualiza barra/estado via JobsPanel.updateLocalJob(jobId, { progress, state, completed }).
â”‚ â”‚ â€“ Se erro ao iniciar: marca job como erro ao iniciar.
â”‚ â”‚
â”‚ â”œâ”€ jobs-panel.js â† painel de processos genÃ©rico (reutilizado)
â”‚ â”‚ â€¢ MantÃ©m lista jobs[] e renderiza o painel fixo no canto inferior direito.
â”‚ â”‚ â€¢ API global window.JobsPanel:
â”‚ â”‚ â€“ addLocalJob({ title, accountKey, accountLabel }) â†’ jobId
â”‚ â”‚ â€“ updateLocalJob(jobId, { progress, state, completed, accountKey, accountLabel })
â”‚ â”‚ â€“ mergeApiJobs(list) (para integraÃ§Ãµes com backend que devolve lista de jobs)
â”‚ â”‚ â€“ show() / hide()
â”‚ â”‚ â€¢ Exibe tÃ­tulo, badge da conta, estado textual e barra de progresso.
â”‚ â”‚
â”‚ â””â”€ demais JS globais (dashboard.js, remover-promocao.js, account-bar.js, etc.)
â”‚
â”œâ”€ public/css/
â”‚ â”œâ”€ dashboard.css
â”‚ â”‚ â€¢ Estilo global da aplicaÃ§Ã£o: header amarelo, nav de abas, botÃµes base, layout .page-wrap, .container, etc.
â”‚ â”‚
â”‚ â”œâ”€ promo-jobs.css
â”‚ â”‚ â€¢ Estilos do painel de processos (#bulkJobsPanel.jobs-panel, .job-row, .job-bar, etc.).
â”‚ â”‚ â€¢ Reutilizado em Remover PromoÃ§Ãµes e ExclusÃ£o de AnÃºncios.
â”‚ â”‚
â”‚ â”œâ”€ excluir-anuncio.css â† estilo especÃ­fico da tela
â”‚ â”‚ â€¢ Usa o mesmo â€œtema MLâ€ da remover-promocao, mas com arquivo prÃ³prio:
â”‚ â”‚ â€“ .container â†’ card branco central com borda suave e sombra.
â”‚ â”‚ â€“ h1 com Ã­cone de lixeira e underline colorido.
â”‚ â”‚ â€“ .form-group para campos de MLB Ãºnico e em lote.
â”‚ â”‚ â€“ input, textarea com bordas arredondadas, highlight em foco.
â”‚ â”‚ â€“ .buttons-row com espaÃ§amento e uso das classes .btn-primary, .btn-warning, .btn-secondary.
â”‚ â”‚ â€“ .result-panel para o bloco JSON de resposta (fundo levemente verde e borda esquerda).
â”‚ â”‚ â€¢ Complementa dashboard.css, nÃ£o substitui.
â”‚ â”‚
â”‚ â””â”€ outros CSS (remover-promocao.css, publicidade.css, etc.)
â”‚
â””â”€ config/ & middleware/
â”œâ”€ middleware/ensureAccount.js
â”‚ â€¢ Garante res.locals.accountKey / res.locals.accountLabel e cookie ml_account antes de chegar nas rotas.
â”œâ”€ middleware/authMiddleware.js
â”‚ â€¢ Garante que o token ML esteja vÃ¡lido para a conta corrente (usado em quase todas as rotas protegidas).
â”œâ”€ config/config.js
â”‚ â€¢ URLs base do ML (items, users_me, etc.) usadas em excluirAnuncioService.
â””â”€ TokenService e demais configs â€“ dÃ£o suporte Ã  autenticaÃ§Ã£o e renovaÃ§Ã£o de token usada pela exclusÃ£o.


Filtro AvanÃ§ado de AnÃºncios (COM JOBS)

/ (raiz do projeto)
â”œâ”€ index.js
â”‚ â”œâ”€ Sobe o Express, registra middlewares globais (cookieParser, json, estÃ¡ticos, etc.)
â”‚ â”œâ”€ app.use('/api/analytics', analyticsFiltroAnunciosRoutes) # (ou app.use(analyticsFiltroAnunciosRoutes) dependendo do seu padrÃ£o)
â”‚ â””â”€ GET /filtro-anuncios (via htmlRoutes/rota direta) â†’ abre a tela HTML
â”‚
â”œâ”€ routes/
â”‚ â”œâ”€ analytics-filtro-anuncios-routes.js # Rotas HTTP da feature "Filtro AvanÃ§ado de AnÃºncios"
â”‚ â”‚ â€¢ POST /api/analytics/filtro-anuncios/jobs
â”‚ â”‚ -> cria um job Bull (enqueue) com { token, filters }
â”‚ â”‚ -> responde 202: { job_id, endpoints, filters }
â”‚ â”‚
â”‚ â”‚ â€¢ GET /api/analytics/filtro-anuncios/jobs/:job_id
â”‚ â”‚ -> lÃª status do job + metadata do arquivo
â”‚ â”‚ -> responde JSON: { status, progress, total, error?, endpoints }
â”‚ â”‚
â”‚ â”‚ â€¢ GET /api/analytics/filtro-anuncios/jobs/:job_id/items
â”‚ â”‚ -> pagina resultados salvos no disco (JSON)
â”‚ â”‚ -> aplica busca local opcional: ?q=...
â”‚ â”‚ -> responde JSON: { page, limit, total, data:[...] }
â”‚ â”‚
â”‚ â”‚ â€¢ GET /api/analytics/filtro-anuncios/jobs/:job_id/download.csv
â”‚ â”‚ -> gera CSV server-side a partir do JSON final do job
â”‚ â”‚ -> Content-Disposition attachment
â”‚ â”‚
â”‚ â”‚ â€¢ COMPAT: GET /api/analytics/filtro-anuncios
â”‚ â”‚ - sem job_id: cria job e responde 202
â”‚ â”‚ - com job_id: retorna items do job chamando handleJobItems (sem loop)
â”‚ â”‚
â”‚ â”‚ Helpers internos importantes:
â”‚ â”‚ â€¢ pickAccountKey(req) -> conta via cookie/header/query
â”‚ â”‚ â€¢ resolveAccessToken(req, accountKey) -> pega token (middleware / bearer / ml-auth fallback)
â”‚ â”‚ â€¢ parseFiltersFromReq(req) -> normaliza filtros (datas, status, vendas, visitas, envio/tipo/detalhes...)
â”‚ â”‚ â€¢ handleJobItems(req,res) -> paginaÃ§Ã£o + busca â€œpÃ³s-jobâ€ (q) e shape pro front
â”‚ â”‚ â€¢ CSV helpers: csvEscape(), toCSV()
â”‚ â”‚
â”‚ â””â”€ htmlRoutes.js (ou equivalente)
â”‚ â€¢ GET /filtro-anuncios -> views/filtro-anuncios.html
â”‚
â”œâ”€ services/
â”‚ â”œâ”€ filtroAnunciosQueueService.js # ğŸ’¥ NÃºcleo do processamento assÃ­ncrono (Bull + ML APIs)
â”‚ â”‚
â”‚ â”‚ Infra:
â”‚ â”‚ â€¢ Bull('Filtro Anuncios Export Queue') -> fila Redis
â”‚ â”‚ â€¢ resultsDir = /results -> persiste meta + resultados por job
â”‚ â”‚ â€¢ _metaPath(jobId) -> {jobId}_filtro_metadata.json
â”‚ â”‚ â€¢ _dataPath(jobId) -> {jobId}_filtro_resultados.json
â”‚ â”‚ â€¢ _writeMeta(jobId, patch) -> salva status/progresso/erro
â”‚ â”‚
â”‚ â”‚ Processador:
â”‚ â”‚ â€¢ queue.process('export', 1, async(job)) -> executa pipeline de coleta+filtros
â”‚ â”‚ Pipeline (ordem real):
â”‚ â”‚ 1) getSellerId(token) -> /users/me
â”‚ â”‚ 2) fetchAllItemIds({sellerId,status}) -> /users/:id/items/search (scan + fallback offset<=1000)
â”‚ â”‚ 3) fetchItemsBatch({ids}) -> /items?ids=... (batch 20)
â”‚ â”‚ -> normaliza â€œrows baseâ€:
â”‚ â”‚ { mlb, sku, title, listing_type_id, tipo, shipping_free, envio, catalog_listing, detalhes, visits:null, sales_units:0, sold_value_cents:0 }
â”‚ â”‚ 4) Filtros baratos (sem perÃ­odo):
â”‚ â”‚ - envio (free/buyer)
â”‚ â”‚ - tipo (classic/premium via listing_type_id)
â”‚ â”‚ - detalhes (catalog/normal via catalog_listing)
â”‚ â”‚ 5) Vendas no perÃ­odo (sempre, para manter colunas e filtro):
â”‚ â”‚ fetchSalesMap({date_from,date_to}) -> /orders/search (paid) paginado
â”‚ â”‚ -> preenche sales_units e sold_value_cents
â”‚ â”‚ -> aplica filtro sales_op (gt/lt) se ativo
â”‚ â”‚ 6) Visitas (caro):
â”‚ â”‚ - sÃ³ busca se visits_op != all
â”‚ â”‚ fetchVisitsMap({ids,date_from,date_to}) -> /items/visits (1 id por request) c/ concorrÃªncia
â”‚ â”‚ -> aplica filtro visits_op (gt/lt) se ativo
â”‚ â”‚ - se nÃ£o ativo: visits = null (UI mostra "-")
â”‚ â”‚ 7) Sort final:
â”‚ â”‚ sort_by: sold_value | sales_units | title
â”‚ â”‚ sort_dir: asc | desc
â”‚ â”‚ 8) Persiste JSON final no disco + meta concluÃ­do
â”‚ â”‚
â”‚ â”‚ Helpers internos importantes:
â”‚ â”‚ â€¢ httpGetJson(url, headers, retries) -> fetch com retry (429/5xx)
â”‚ â”‚ â€¢ chunk(arr, size), sleep(ms)
â”‚ â”‚ â€¢ mapTipo(), mapEnvio(), mapDetalhes()
â”‚ â”‚
â”‚ â”‚ API do service:
â”‚ â”‚ â€¢ enqueue({token, filters}) -> job.id
â”‚ â”‚ â€¢ getStatus(jobId) -> status + progress + meta.total/error
â”‚ â”‚ â€¢ getResults(jobId) -> lÃª JSON final do disco
â”‚ â”‚
â”‚ â””â”€ lib/redisClient.js / services/ml-auth.js / tokenService.js
â”‚ â€¢ redisClient: conexÃ£o Bull/Redis
â”‚ â€¢ ml-auth/tokenService: usados pelo routes pra obter token (resolveAccessToken)
â”‚
â”œâ”€ views/
â”‚ â”œâ”€ filtro-anuncios.html # Tela â€œFiltro AvanÃ§ado de AnÃºnciosâ€
â”‚ â”‚ â€¢ header padrÃ£o (conta atual + Status + Trocar Conta)
â”‚ â”‚ â€¢ card de filtros (datas, vendas, status, envio/tipo/detalhes e filtros â€œcinzaâ€ guardados)
â”‚ â”‚ â€¢ tabela com 8 colunas:
â”‚ â”‚ MLB | SKU | Nome anÃºncio | Tipo | Envios | Valor venda | Qnt vendas | Visitas
â”‚ â”‚ â€¢ inclui:
â”‚ â”‚ <link rel="stylesheet" href="/css/dashboard.css">
â”‚ â”‚ <link rel="stylesheet" href="/css/filtro-anuncios.css">
â”‚ â”‚ <script src="/js/filtro-anuncios.js"></script>
â”‚ â”‚
â”‚ â””â”€ (partials/â€¦ se existirem)
â”‚
â””â”€ public/
â”œâ”€ js/
â”‚ â”œâ”€ filtro-anuncios.js # Frontend (orquestra JOBS + paginaÃ§Ã£o + busca local)
â”‚ â”‚ â€¢ Cria job: POST /api/analytics/filtro-anuncios/jobs
â”‚ â”‚ â€¢ Poll status: GET /api/analytics/filtro-anuncios/jobs/:job_id
â”‚ â”‚ â€¢ Carrega pÃ¡gina: GET /api/analytics/filtro-anuncios/jobs/:job_id/items?page&limit&q
â”‚ â”‚ â€¢ Exporta CSV: redireciona GET /api/analytics/filtro-anuncios/jobs/:job_id/download.csv
â”‚ â”‚ â€¢ MantÃ©m state (filtros, job_id, paginaÃ§Ã£o, rows)
â”‚ â”‚ â€¢ Render:
â”‚ â”‚ - tabela (8 colunas; colspan=8)
â”‚ â”‚ - pager
â”‚ â”‚ - loading row e empty prompt
â”‚ â”‚ â€¢ Retoma job por URL: ?job_id=...
â”‚ â”‚
â”‚ â””â”€ (outros JS globais: account-bar.js, etc.)
â”‚
â”œâ”€ css/
â”‚ â”œâ”€ filtro-anuncios.css # Estilos especÃ­ficos da tela de filtro
â”‚ â”œâ”€ dashboard.css # Estilos globais
â”‚ â””â”€ ...
â”‚
â””â”€ img/
â””â”€ ...

Login (JWT do app)

/ (raiz do projeto)
â”œâ”€ index.js
â”‚ â”œâ”€ Sobe o Express, registra middlewares globais (json/urlencoded, cookieParser, estÃ¡ticos)
â”‚ â”œâ”€ Rotas pÃºblicas:
â”‚ â”‚ â€¢ GET /selecao-plataforma -> views/selecao-plataforma.html
â”‚ â”‚ â€¢ GET /login -> views/login.html
â”‚ â”‚ â€¢ app.use('/api/auth', authRoutes) -> rotas de autenticaÃ§Ã£o (JWT)
â”‚ â”œâ”€ app.use(ensureAuth) # âœ… A PARTIR DAQUI tudo exige login (cookie auth_token)
â”‚ â”œâ”€ GET /select-conta -> views/select-conta.html (jÃ¡ autenticado)
â”‚ â””â”€ app.use(ensureAccount) -> exige conta escolhida (cookie ml_account) p/ seguir no app

â”œâ”€ routes/
â”‚ â”œâ”€ authRoutes.js # âœ… Rotas HTTP do login (JWT do app)
â”‚ â”‚ â€¢ POST /api/auth/login
â”‚ â”‚ -> recebe { email, senha }
â”‚ â”‚ -> busca usuÃ¡rio no banco (tabela usuarios)
â”‚ â”‚ -> valida senha:
â”‚ â”‚ - bcrypt.compare(senha, senha_hash) (quando senha_hash existe)
â”‚ â”‚ -> gera JWT (12h) com { uid, email, nivel, nome }
â”‚ â”‚ -> seta cookie httpOnly: auth_token
â”‚ â”‚ -> responde { ok:true, user, redirect:'/select-conta' }
â”‚ â”‚
â”‚ â”‚ â€¢ POST /api/auth/logout
â”‚ â”‚ -> res.clearCookie('auth_token')
â”‚ â”‚ -> responde { ok:true }
â”‚ â”‚
â”‚ â”‚ â€¢ GET /api/auth/me
â”‚ â”‚ -> lÃª cookie auth_token
â”‚ â”‚ -> jwt.verify()
â”‚ â”‚ -> responde { logged:true, user } ou { logged:false }
â”‚ â”‚
â”‚ â””â”€ accountRoutes.js
â”‚ â€¢ GET /api/account/current -> retorna conta selecionada (para header)
â”‚ â€¢ POST /api/account/select -> grava ml_account
â”‚ â€¢ POST /api/account/clear -> limpa ml_account

â”œâ”€ middleware/
â”‚ â”œâ”€ ensureAuth.js # âœ… Gate do sistema (login do app)
â”‚ â”‚ â€¢ LÃª cookie auth_token
â”‚ â”‚ â€¢ jwt.verify(JWT_SECRET)
â”‚ â”‚ â€¢ injeta req.user / res.locals.user
â”‚ â”‚ â€¢ se nÃ£o logado:
â”‚ â”‚ - HTML -> redirect /login
â”‚ â”‚ - API -> 401 JSON
â”‚ â”‚
â”‚ â”œâ”€ ensureAccount.js # âœ… Exige conta selecionada (ml_account)
â”‚ â”‚ â€¢ valida cookie ml_account
â”‚ â”‚ â€¢ injeta res.locals.accountKey / accountLabel / mlCreds
â”‚ â”‚ â€¢ se nÃ£o tiver conta -> redirect /select-conta (ou 400/401 em API)
â”‚ â”‚
â”‚ â””â”€ (seu authMiddleware ML) middleware/authMiddleware.js
â”‚ â€¢ garante token do Mercado Livre vÃ¡lido para rotas ML do app (apÃ³s conta selecionada)

â”œâ”€ db/
â”‚ â”œâ”€ db.js # pool/conexÃ£o Postgres
â”‚ â””â”€ (tabela usuarios)
â”‚ â€¢ usuarios(id, nome, email, senha_hash, nivel, criado_em, ultimo_login_em)

â”œâ”€ views/
â”‚ â”œâ”€ selecao-plataforma.html # botÃ£o â€œMercado Livreâ€ -> /login
â”‚ â”œâ”€ login.html # form do login (frontend)
â”‚ â””â”€ select-conta.html # seleÃ§Ã£o de conta apÃ³s login

â””â”€ public/
â”œâ”€ css/
â”‚ â”œâ”€ selecao-plataforma.css
â”‚ â””â”€ login.css
â””â”€ js/
â”œâ”€ login.js (se existir / recomendado)
â”‚ â€¢ intercepta submit
â”‚ â€¢ POST /api/auth/login com email/senha
â”‚ â€¢ se ok -> window.location = redirect
â”‚ â€¢ se erro -> mostra msg
â””â”€ (JS globais do dashboard etc.)

Admin â€¢ UsuÃ¡rios (listagem + CRUD)

/ (raiz do projeto)
â”œâ”€ index.js
â”‚ â”œâ”€ app.use(ensureAuth) # âœ… tudo abaixo exige login (JWT)
â”‚ â”œâ”€ /nao-autorizado (HTML)
â”‚ â”œâ”€ ensureAdminOnly (middleware inline ou separado)
â”‚ â”œâ”€ Rotas de pÃ¡gina (HTML):
â”‚ â”‚ â€¢ GET /admin/usuarios -> views/admin-usuarios.html (protegida)
â”‚ â”‚ -> se nÃ£o admin: redirect /nao-autorizado
â”‚ â””â”€ Rotas API admin:
â”‚ â€¢ app.use('/api/admin', adminUsuariosRoutes)
â”‚ -> router usa ensureAuthApi + ensureAdmin

â”œâ”€ routes/
â”‚ â”œâ”€ adminUsuariosRoutes.js # âœ… Rotas HTTP da feature "Admin UsuÃ¡rios"
â”‚ â”‚ (router.use(ensureAuthApi, ensureAdmin)) # sÃ³ admin
â”‚ â”‚
â”‚ â”‚ â€¢ GET /api/admin/usuarios
â”‚ â”‚ -> lista usuÃ¡rios (id, nome, email, nivel, criado_em, ultimo_login_em)
â”‚ â”‚ -> responde { ok:true, usuarios:[...] }
â”‚ â”‚
â”‚ â”‚ â€¢ POST /api/admin/usuarios
â”‚ â”‚ -> cria usuÃ¡rio com senha em HASH
â”‚ â”‚ -> bcrypt.hash(senha, 10)
â”‚ â”‚ -> insert em usuarios
â”‚ â”‚ -> responde { ok:true, usuario }
â”‚ â”‚
â”‚ â”‚ â€¢ PUT /api/admin/usuarios/:id
â”‚ â”‚ -> edita nome/email/nivel
â”‚ â”‚ -> opcional: se senha veio, gera bcrypt.hash e atualiza senha_hash
â”‚ â”‚ -> responde { ok:true, usuario }
â”‚ â”‚
â”‚ â”‚ â€¢ DELETE /api/admin/usuarios/:id
â”‚ â”‚ -> remove usuÃ¡rio
â”‚ â”‚ -> (opcional) bloqueia apagar a si mesmo
â”‚ â”‚ -> responde { ok:true }
â”‚ â”‚
â”‚ â”‚ (melhoria recomendada p/ paginaÃ§Ã£o server-side)
â”‚ â”‚ â€¢ GET /api/admin/usuarios?page=1&limit=25&q=abc
â”‚ â”‚ -> retorna { ok:true, page, limit, total, usuarios:[...] }
â”‚ â”‚ -> reduz carga e facilita paginaÃ§Ã£o real
â”‚ â”‚
â”‚ â””â”€ (htmlRoutes.js se vocÃª centraliza views)
â”‚ â€¢ GET /admin/usuarios -> views/admin-usuarios.html

â”œâ”€ middleware/
â”‚ â”œâ”€ jwtAuth.js # âœ… versÃ£o para API (JSON)
â”‚ â”‚ â€¢ ensureAuthApi
â”‚ â”‚ -> valida cookie auth_token
â”‚ â”‚ -> injeta req.user
â”‚ â”‚ -> se nÃ£o logado: 401 JSON
â”‚ â”‚
â”‚ â”‚ â€¢ ensureAdmin
â”‚ â”‚ -> req.user.nivel === 'administrador'
â”‚ â”‚ -> se nÃ£o: 403 JSON
â”‚ â”‚
â”‚ â””â”€ ensureAuth.js # gate para pÃ¡ginas HTML (redirect /login)

â”œâ”€ views/
â”‚ â”œâ”€ admin.html (se existir: card â€œUsuÃ¡riosâ€ no dashboard/tab Admin)
â”‚ â””â”€ admin-usuarios.html # Tela â€œListagem de usuÃ¡riosâ€ (estilo imagem 3)
â”‚ â€¢ sidebar + header + search + tabela
â”‚ â€¢ paginaÃ§Ã£o (25 por pÃ¡gina)
â”‚ â€¢ botÃµes: Atualizar, + Cadastrar, Editar, Remover
â”‚ â€¢ inclui:
â”‚ <link rel="stylesheet" href="/css/dashboard.css?v=2">
â”‚ <link rel="stylesheet" href="/css/admin-usuarios.css?v=1"> (ou tudo no dashboard.css)
â”‚ <script src="/js/admin-usuarios.js?v=1"></script>

â””â”€ public/
â”œâ”€ js/
â”‚ â””â”€ admin-usuarios.js # Frontend (orquestra listagem + CRUD)
â”‚ â€¢ loadUsers():
â”‚ - GET /api/admin/usuarios (ou com ?page&limit&q)
â”‚ â€¢ renderTable(rows)
â”‚ â€¢ paginaÃ§Ã£o:
â”‚ - mantÃ©m state { page, limit=25, total }
â”‚ â€¢ criar usuÃ¡rio:
â”‚ - POST /api/admin/usuarios { nome, email, senha, nivel }
â”‚ - server faz hash (bcrypt) âœ…
â”‚ â€¢ editar:
â”‚ - PUT /api/admin/usuarios/:id { nome,email,nivel, senha? }
â”‚ â€¢ remover:
â”‚ - DELETE /api/admin/usuarios/:id
â”‚ â€¢ tratamento de erro:
â”‚ - 401 -> redirect /login
â”‚ - 403 -> redirect /nao-autorizado
â”‚
â””â”€ css/
â”œâ”€ dashboard.css # estilos globais
â””â”€ admin-usuarios.css # estilos da tela (sidebar sticky, tabela, etc.)


//SISTEMA NOVO MODELO
OAuth Mercado Livre + SeleÃ§Ã£o de Conta (novo fluxo) + SeguranÃ§a de Acesso + Fix do 403 (mapa atualizado)
/ (raiz do projeto)

â”œâ”€ index.js
â”‚ â”œâ”€ Middlewares bÃ¡sicos (pÃºblico)
â”‚ â”‚ â”œâ”€ express.json / express.urlencoded
â”‚ â”‚ â”œâ”€ cors()  (âš ï¸ se tiver cross-origin + cookies, usar origin + credentials)
â”‚ â”‚ â”œâ”€ cookieParser()
â”‚ â”‚ â””â”€ express.static(/public)
â”‚ â”‚
â”‚ â”œâ”€ Rotas pÃºblicas (SEM LOGIN)
â”‚ â”‚ â”œâ”€ GET /                -> redirect /selecao-plataforma
â”‚ â”‚ â”œâ”€ GET /selecao-plataforma -> views/selecao-plataforma.html
â”‚ â”‚ â”œâ”€ GET /login           -> views/login.html
â”‚ â”‚ â”œâ”€ GET /cadastro        -> views/cadastro.html
â”‚ â”‚ â”œâ”€ GET /nao-autorizado  -> views/nao-autorizado.html (HTML 403)
â”‚ â”‚ â”œâ”€ app.use('/api/auth', authRoutes)  # login/logout/me (JWT do app)
â”‚ â”‚ â”‚
â”‚ â”‚ â”œâ”€ POST /api/ml/logout (logout â€œcompletoâ€)
â”‚ â”‚ â”‚ â”œâ”€ clearCookie('auth_token')
â”‚ â”‚ â”‚ â”œâ”€ clearCookie('meli_conta_id')   âœ… OAuth (NOVO)
â”‚ â”‚ â”‚ â””â”€ clearCookie('ml_account')      âœ… Legacy (se existir)
â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€ Monitoramento/Debug ABERTOS
â”‚ â”‚   â”œâ”€ GET /api/system/health
â”‚ â”‚   â”œâ”€ GET /api/system/stats
â”‚ â”‚   â””â”€ GET /test-basic
â”‚ â”‚
â”‚ â”œâ”€ âœ… app.use(ensureAuth)  # daqui pra baixo TUDO exige login do app (JWT cookie auth_token)
â”‚ â”‚
â”‚ â”œâ”€ OAuth Mercado Livre (vincular contas via autorizaÃ§Ã£o)
â”‚ â”‚ â”œâ”€ app.use('/api/meli', meliOAuthRoutes)   # PKCE start/callback + contas/seleÃ§Ã£o no DB
â”‚ â”‚ â””â”€ GET /vincular-conta -> views/vincular-conta.html
â”‚ â”‚
â”‚ â”œâ”€ ensureAdminOnly (middleware inline no index.js)
â”‚ â”‚ â”œâ”€ usado para pÃ¡ginas/rotas especÃ­ficas (ex: /admin/usuarios e /api/excluir-anuncio)
â”‚ â”‚ â””â”€ HTML -> redirect /nao-autorizado | API -> 403 JSON
â”‚ â”‚
â”‚ â”œâ”€ Admin (SOMENTE ADMIN)
â”‚ â”‚ â”œâ”€ GET /admin/usuarios -> views/admin-usuarios.html (ensureAdminOnly)
â”‚ â”‚ â””â”€ app.use('/api/admin', adminUsuariosRoutes)
â”‚ â”‚
â”‚ â”œâ”€ SeleÃ§Ã£o de conta (APÃ“S LOGIN)
â”‚ â”‚ â”œâ”€ GET /select-conta -> views/select-conta.html
â”‚ â”‚ â””â”€ app.use('/api/account', accountRoutes)  # âœ… seleÃ§Ã£o/list/current/clear (OAuth + Legacy)
â”‚ â”‚
â”‚ â”œâ”€ ProteÃ§Ã£o por conta selecionada (OAuth)
â”‚ â”‚ â”œâ”€ app.use(ensureAccount)  # âœ… exige cookie meli_conta_id e injeta res.locals.mlCreds
â”‚ â”‚ â””â”€ Debug: GET /api/account/whoami -> mostra conta + usuÃ¡rio do JWT + hasCreds
â”‚ â”‚
â”‚ â”œâ”€ ProteÃ§Ã£o por token ML vÃ¡lido
â”‚ â”‚ â””â”€ app.use(authMiddleware)  # âœ… garante access_token vÃ¡lido (renova se preciso)
â”‚ â”‚
â”‚ â”œâ”€ Fix crÃ­tico do 403 (Admin-only aplicado errado)
â”‚ â”‚ â””â”€ âœ… correto: aplicar admin-only SOMENTE no prefixo:
â”‚ â”‚     app.use('/api/excluir-anuncio', ensureAdminOnly, excluirAnuncioRoutes)
â”‚ â”‚     (antes, quando era â€œsem prefixoâ€, derrubava tudo apÃ³s esse ponto)
â”‚ â”‚
â”‚ â””â”€ Rotas protegidas do app (apÃ³s JWT + conta + token ML)
â”‚   â”œâ”€ /api/analise-anuncios           -> adAnalysisRoutes
â”‚   â”œâ”€ tokenRoutes                    -> (prefixo conforme seu router)
â”‚   â”œâ”€ /api/validar-dimensoes         -> validarDimensoesRoutes
â”‚   â”œâ”€ /api/excluir-anuncio           -> excluirAnuncioRoutes (ADMIN ONLY no index)
â”‚   â”œâ”€ removerPromocaoRoutes          -> promocaoRoutes (prefixo conforme seu router)
â”‚   â”œâ”€ /api/criar-promocao            -> criarPromocaoRoutes
â”‚   â”œâ”€ itemsRoutes                    -> (prefixo conforme seu router)
â”‚   â”œâ”€ promocoesRoutes                -> (prefixo conforme seu router)
â”‚   â”œâ”€ htmlRoutes                     -> pÃ¡ginas do dashboard (protegidas)
â”‚   â”œâ”€ /api/pesquisa-descricao        -> pesquisaDescricaoRoutes
â”‚   â”œâ”€ /api/keyword-analytics         -> keywordAnalyticsRoutes
â”‚   â”œâ”€ /api/analytics                 -> analyticsAbcRoutes + filtroAnunciosRoutes
â”‚   â”œâ”€ estrategicosRoutes             -> (prefixo conforme seu router)
â”‚   â”œâ”€ /api/full                      -> fullRoutes
â”‚   â”œâ”€ /api/publicidade               -> publicidadeRoutes
â”‚   â””â”€ GETs auxiliares (HTML) servidos via sendFile (onde vocÃª colocou)
â”‚
â”‚ â”œâ”€ Errors
â”‚ â”‚ â”œâ”€ handler 500 (json)
â”‚ â”‚ â””â”€ handler 404 (json)
â”‚ â”‚
â”‚ â””â”€ Graceful shutdown + queueService


1) Middleware: Login do app (JWT) com HTML/JSON seguro
middleware/

â””â”€ ensureAuth.js  âœ… (atualizado)
â”œâ”€ lÃª cookie: auth_token
â”œâ”€ valida JWT_SECRET + jwt.verify()
â”œâ”€ injeta:
â”‚ â”œâ”€ req.user = payload { uid, email, nivel, nome, iat, exp }
â”‚ â””â”€ res.locals.user = payload
â”œâ”€ comportamento correto:
â”‚ â”œâ”€ PÃGINA (GET + Accept html): redirect /login
â”‚ â””â”€ API/FETCH (/api/* ou Accept JSON ou X-Requested-With): 401 JSON { ok:false, redirect:'/login' }
â””â”€ requireNivel/ensureAdmin:
  â”œâ”€ se nÃ£o admin:
  â”‚ â”œâ”€ HTML: redirect /nao-autorizado
  â”‚ â””â”€ API: 403 JSON


2) Middleware: Exigir conta selecionada (OAuth) + compat legado comentado
middleware/

â””â”€ ensureAccount.js  âœ… (novo padrÃ£o OAuth)
â”œâ”€ cookie OAuth: meli_conta_id
â”œâ”€ OPEN_PREFIXES:
â”‚ â”œâ”€ pÃ¡ginas pÃºblicas (/login, /cadastro, /selecao-plataforma, /nao-autorizado)
â”‚ â”œâ”€ auth do app (/api/auth)
â”‚ â”œâ”€ seleÃ§Ã£o/vinculaÃ§Ã£o (/select-conta, /vincular-conta)
â”‚ â”œâ”€ OAuth ML (/api/meli/*)
â”‚ â”œâ”€ system/health/debug
â”‚ â””â”€ estÃ¡ticos (/public, /css, /js, /img, etc.)
â”œâ”€ exige req.user.uid (ensureAuth deve rodar antes)
â”œâ”€ se cookie ausente/invÃ¡lido:
â”‚ â”œâ”€ HTML GET: redirect /select-conta
â”‚ â””â”€ API: 401 JSON { ok:false, redirect:'/select-conta' }
â”œâ”€ carrega dados do DB:
â”‚ â”œâ”€ empresa do usuÃ¡rio: empresa_usuarios -> empresas
â”‚ â”œâ”€ valida se meli_conta_id pertence Ã  empresa: meli_contas
â”‚ â””â”€ carrega tokens 1:1: meli_tokens (por meli_conta_id)
â”œâ”€ injeta identidade (UI/log):
â”‚ â”œâ”€ res.locals.accountMode = 'oauth'
â”‚ â”œâ”€ res.locals.accountKey = '<meli_conta_id>'
â”‚ â”œâ”€ res.locals.accountLabel = apelido || `Conta <meli_user_id>`
â”‚ â”œâ”€ res.locals.empresaId / empresaNome
â”‚ â””â”€ res.locals.mlCreds (bag central)
â”‚    â”œâ”€ app_id / client_secret / redirect_uri (do ENV)
â”‚    â”œâ”€ account_key / meli_conta_id / meli_user_id / site_id / status
â”‚    â””â”€ access_token / refresh_token / access_expires_at / scope (do DB; pode vir null)
â””â”€ LEGADO permanece comentado no final (cookie ml_account + env ML_<KEY>_*)


3) SeleÃ§Ã£o de Conta (novo padrÃ£o com compat de front)
routes/

â””â”€ accountRoutes.js  âœ… (atualizado)
â”œâ”€ Cookies (tem que bater com ensureAccount.js)
â”‚ â”œâ”€ COOKIE_OAUTH  = 'meli_conta_id'  âœ…
â”‚ â””â”€ COOKIE_LEGACY = 'ml_account'
â”‚
â”œâ”€ GET /api/account/list
â”‚ â”œâ”€ exige req.user.uid
â”‚ â”œâ”€ lista contas OAuth do DB (empresa do usuÃ¡rio)
â”‚ â”‚ â””â”€ join meli_tokens p/ has_tokens
â”‚ â”œâ”€ lista contas legacy (env) opcional
â”‚ â”œâ”€ retorna:
â”‚ â”‚ â”œâ”€ { oauth:[...], legacy:[...], current }
â”‚ â”‚ â””â”€ + compat navbar/front:
â”‚ â”‚    accountType, accountKey, label, success:true
â”‚
â”œâ”€ GET /api/account/current
â”‚ â”œâ”€ lÃª cookie meli_conta_id (ou legacy)
â”‚ â”œâ”€ valida contra DB (empresa + conta)
â”‚ â”œâ”€ se cookie invÃ¡lido: clearCookie(meli_conta_id)
â”‚ â””â”€ retorna payload â€œflatâ€ compat:
â”‚    { current, accountType, accountKey, label, ok:true, success:true }
â”‚
â”œâ”€ POST /api/account/select
â”‚ â”œâ”€ OAuth: body { meliContaId }
â”‚ â”‚ â”œâ”€ valida se pertence Ã  empresa
â”‚ â”‚ â”œâ”€ seta cookie meli_conta_id
â”‚ â”‚ â””â”€ limpa cookie ml_account
â”‚ â”œâ”€ Legacy: body { accountKey }
â”‚ â”‚ â”œâ”€ seta cookie ml_account
â”‚ â”‚ â””â”€ limpa cookie meli_conta_id
â”‚ â””â”€ retorna buildCurrentPayload(...) (flat + current)
â”‚
â””â”€ POST /api/account/clear
  â”œâ”€ clearCookie(meli_conta_id)
  â”œâ”€ clearCookie(ml_account)
  â””â”€ { ok:true, success:true }

ObservaÃ§Ã£o: VocÃª agora tem 2 formas de â€œselecionar contaâ€:
- via /api/account/select (recomendado manter como padrÃ£o do front)
- e tambÃ©m existe seleÃ§Ã£o em /api/meli/selecionar (no meliOAuthRoutes)
O ideal Ã© o front escolher 1 padrÃ£o e ficar sÃ³ nele (pra nÃ£o confundir).


4) OAuth Mercado Livre (PKCE + state + DB)
routes/

â””â”€ meliOAuthRoutes.js  âœ…
â”œâ”€ Cookie da conta selecionada (padrÃ£o novo)
â”‚ â””â”€ COOKIE_MELI_CONTA = 'meli_conta_id' âœ…
â”‚
â”œâ”€ GET /api/meli/contas
â”‚ â”œâ”€ exige req.user.uid (ensureAuth)
â”‚ â”œâ”€ busca empresa do usuÃ¡rio
â”‚ â”œâ”€ lista meli_contas por empresa
â”‚ â””â”€ retorna { ok:true, contas:[...], current_meli_conta_id }
â”‚
â”œâ”€ POST /api/meli/selecionar
â”‚ â”œâ”€ body { meli_conta_id }
â”‚ â”œâ”€ valida se pertence Ã  empresa
â”‚ â”œâ”€ seta cookie meli_conta_id
â”‚ â””â”€ retorna { ok:true, meli_conta_id }
â”‚
â”œâ”€ POST /api/meli/limpar-selecao
â”‚ â””â”€ clear cookie meli_conta_id
â”‚
â”œâ”€ POST /api/meli/oauth/start
â”‚ â”œâ”€ gera state + code_verifier + code_challenge (PKCE S256)
â”‚ â”œâ”€ salva oauth_states (10 min)
â”‚ â”œâ”€ monta URL AUTH_BASE (auth.mercadolivre.com.br/authorization)
â”‚ â””â”€ responde { ok:true, url }
â”‚
â”œâ”€ GET /api/meli/oauth/callback?code&state
â”‚ â”œâ”€ valida state no DB + expiraÃ§Ã£o
â”‚ â”œâ”€ troca code por token em TOKEN_URL (api.mercadolibre.com/oauth/token)
â”‚ â”œâ”€ upsert meli_contas (empresa + meli_user_id)
â”‚ â”œâ”€ upsert meli_tokens (1:1 por meli_conta_id)
â”‚ â”œâ”€ apaga oauth_states (uso Ãºnico)
â”‚ â”œâ”€ seta cookie meli_conta_id (opcional, mas vocÃª fez âœ…)
â”‚ â””â”€ redirect para return_to (sanitizado)
â”‚
â””â”€ GET /api/meli/current
  â”œâ”€ lÃª cookie meli_conta_id
  â”œâ”€ valida conta na empresa
  â””â”€ retorna { ok:true, selected:true/false, label, site_id, status, ... }

tabelas (banco)

â”œâ”€ oauth_states
â”‚ â”œâ”€ state (PK), empresa_id, usuario_id
â”‚ â”œâ”€ code_verifier, return_to
â”‚ â””â”€ expira_em
â”‚
â”œâ”€ meli_contas
â”‚ â”œâ”€ id (PK), empresa_id
â”‚ â”œâ”€ meli_user_id, apelido, site_id, status
â”‚ â””â”€ criado_em, atualizado_em, ultimo_uso_em
â”‚
â””â”€ meli_tokens
  â”œâ”€ meli_conta_id (unique / FK)
  â”œâ”€ access_token, access_expires_at
  â”œâ”€ refresh_token, scope
  â””â”€ refresh_obtido_em, ultimo_refresh_em


5) UI: SeleÃ§Ã£o de Conta (tela)
views/

â””â”€ select-conta.html
â”œâ”€ lista cards de contas (OAuth) vindas do backend
â”œâ”€ ao clicar num card: seleciona cookie meli_conta_id
â”œâ”€ botÃµes: â€œVincular Contaâ€, â€œLimpar seleÃ§Ã£oâ€, â€œSairâ€
â””â”€ (modo legacy pode existir/ficar oculto)

public/js/

â””â”€ select-conta.js (esperado)
â”œâ”€ loadContas():
â”‚ â”œâ”€ (opÃ§Ã£o A) GET /api/account/list
â”‚ â””â”€ (opÃ§Ã£o B) GET /api/meli/contas
â”œâ”€ selectConta(id):
â”‚ â”œâ”€ (opÃ§Ã£o A) POST /api/account/select { meliContaId }
â”‚ â””â”€ (opÃ§Ã£o B) POST /api/meli/selecionar { meli_conta_id }
â”‚ â””â”€ redirect /dashboard
â”œâ”€ clearConta():
â”‚ â”œâ”€ (opÃ§Ã£o A) POST /api/account/clear
â”‚ â””â”€ (opÃ§Ã£o B) POST /api/meli/limpar-selecao
â””â”€ ObservaÃ§Ã£o importante:
  - escolha UM padrÃ£o (accountRoutes OU meliOAuthRoutes) para reduzir confusÃ£o.


6) Middleware: Garantir token ML vÃ¡lido para rotas que chamam ML
middleware/

â””â”€ authMiddleware.js
â”œâ”€ SKIP_PATHS (deve ignorar o que nÃ£o precisa token ML)
â”‚ â”œâ”€ /api/meli/* (oauth start/callback/contas/selecionar/limpar)
â”‚ â”œâ”€ /api/account/* (list/current/select/clear)
â”‚ â”œâ”€ /api/system/*, /api/health, /health
â”‚ â””â”€ assets/pÃ¡ginas se necessÃ¡rio
â”œâ”€ fluxo:
â”‚ â”œâ”€ lÃª credenciais de res.locals.mlCreds (injetado pelo ensureAccount)
â”‚ â”œâ”€ chama TokenService.renovarTokenSeNecessario(creds)
â”‚ â”œâ”€ se falhar:
â”‚ â”‚ â”œâ”€ HTML: redirect /select-conta (ou /vincular-conta se tokens ausentes)
â”‚ â”‚ â””â”€ API: 401 JSON { ok:false, redirect:'/select-conta' }
â”‚ â””â”€ injeta req.ml com { accessToken, creds, accountKey/Label/Mode }


7) Token Service (renovaÃ§Ã£o) â€” pronto para persistir no banco quando quiser
services/

â””â”€ tokenService.js
â”œâ”€ resolveCreds() unifica leitura:
â”‚ â”œâ”€ app_id/client_secret/redirect_uri
â”‚ â”œâ”€ refresh_token/access_token/access_expires_at
â”‚ â”œâ”€ account_key / meli_conta_id (para logs e persistÃªncia)
â”œâ”€ renovarTokenSeNecessario(creds)
â”‚ â”œâ”€ valida access_token (ex: /users/me)
â”‚ â””â”€ se invÃ¡lido/expirado -> renovarToken(creds)
â”œâ”€ renovarToken(creds)
â”‚ â”œâ”€ refresh_token grant em /oauth/token
â”‚ â”œâ”€ atualiza credenciais em memÃ³ria (e possivelmente process.env por compat)
â”‚ â””â”€ (evoluÃ§Ã£o ideal) se creds.meli_conta_id existir:
â”‚    -> persistir novo access_token + access_expires_at no DB (meli_tokens)
â””â”€ testarToken(creds) -> /users/me


8) Fix do â€œcai em /nao-autorizadoâ€ (403) apÃ³s selecionar conta
index.js (ponto crÃ­tico)

Erro anterior (clÃ¡ssico):
- aplicar ensureAdminOnly â€œglobalâ€ (sem prefixo) e derrubar tudo abaixo.

CorreÃ§Ã£o (obrigatÃ³ria, vocÃª jÃ¡ fez):
app.use('/api/excluir-anuncio', ensureAdminOnly, excluirAnuncioRoutes)

Fluxo final esperado (usuÃ¡rio)

1) /login -> autentica -> cookie auth_token
2) redirect /select-conta
3) /select-conta -> lista contas (GET /api/account/list ou /api/meli/contas)
4) seleciona conta -> seta cookie meli_conta_id (POST /api/account/select ou /api/meli/selecionar)
5) redirect /dashboard
6) a partir daÃ­:
   - ensureAccount injeta mlCreds/tokens
   - authMiddleware garante access_token vÃ¡lido (renova se preciso)
   - rotas que chamam ML funcionam

