<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="/css/dashboard.css" rel="stylesheet"/>
<link href="/css/select-conta.css" rel="stylesheet"/>
<title>Selecionar Conta - API Mercado Livre</title>
</head>
<body>
<header class="account-bar">
<div class="account-bar__left">
<span class="logo">üü°</span>
<span class="app-name">API Mercado Livre</span>
</div>
<div class="account-bar__right">
<div class="account-bar__current">
<span class="lbl">Conta:</span>
<span class="val" id="account-current">Carregando...</span>
</div>
<button class="account-bar__status" id="btn-status" title="Ver status do token">Status</button>
<button class="account-bar__switch" id="account-switch" title="Trocar de conta">Trocar Conta</button>
</div>
</header>
<nav class="main-nav">
<div class="tabs">
<a class="nav-tab" data-tab="dashboard" href="/dashboard">Dashboard</a>
<a class="nav-tab" data-tab="produtos" href="/criar-promocao">Produtos</a>
<a class="nav-tab" data-tab="ia" href="/analise-anuncios">IA &amp; Analytics</a>
<a class="nav-tab" data-tab="benchmarking" href="/benchmarking">Benchmarking</a>
<a class="nav-tab" data-tab="alertas" href="/alertas">Alertas</a>
<a class="nav-tab" data-tab="ml" href="/debug/routes">ML</a>
</div>
</nav>
<div class="modal" id="modal-status">
<div class="modal-content">
<div class="modal-header alt">
<h3>üü¢ Status da Integra√ß√£o</h3>
<span class="close" onclick="fecharModalStatus()">√ó</span>
</div>
<div class="modal-body">
<div class="status-grid">
<div class="stat-mini"><h4 id="status-usuario">‚Äî</h4><p>Usu√°rio</p></div>
<div class="stat-mini"><h4 id="status-token">‚Äî</h4><p>Token (preview)</p></div>
<div class="stat-mini"><h4 id="status-msg">‚Äî</h4><p>Mensagem</p></div>
</div>
<div class="modal-controls">
<button class="btn-small btn-primary" onclick="verificarToken(true)">üîç Verificar</button>
<button class="btn-small btn-success" onclick="renovarToken(true)">üîÑ Renovar</button>
</div>
</div>
</div>
</div>
<main class="page-wrap">
<section class="tab-page active">
<div class="container">
<div class="select-wrap">
<div class="select-head"><span>üîé</span><span>API Mercado Livre</span></div>
<h1 class="select-title">Selecione a conta</h1>
<p class="select-sub">Escolha qual conta deseja usar nesta sess√£o. Voc√™ pode troc√°-la depois pelo bot√£o ‚ÄúTrocar Conta‚Äù no topo do dashboard.</p>
<div class="grid" id="list"></div>
<div class="actions">
<button class="btn btn-ghost" onclick="window.location.href='/dashboard'">Voltar ao Dashboard</button>
<button class="btn btn-warning" onclick="clearAccount()">Limpar Sele√ß√£o</button>
</div>
<div id="status" style="display:none"></div>
</div>
<script>
    const labels = { drossi:'DRossi Interiores', diplany:'Diplany', rossidecor:'Rossi Decor' };

    async function loadAccounts() {
  const list = document.getElementById('list');
  const status = document.getElementById('status');
  try {
    const r = await fetch('/api/account/list', { cache:'no-store' });
    const data = await r.json();

    const items = (data.accounts || []).map(acc => {
      const s = acc.configured ? 'Tokens OK' : 'Tokens ausentes';
      return `
        <button class="acc-btn" onclick="selectAccount('${acc.key}')">
          ${labels[acc.key] || acc.label || acc.key}
          <span class="sub">chave: ${acc.key}<br>${s}</span>
        </button>`;
    }).join('');

    list.innerHTML = items;

    if (data.current) {
      status.style.display = 'block';
      status.textContent = 'Conta atual: ' + (data.currentLabel || data.current);
    }
  } catch (e) {
    list.innerHTML = `<div class="hint">Erro ao carregar contas: ${e.message}</div>`;
  }
}

    async function selectAccount(key) {
      const r = await fetch('/api/account/select', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ accountKey:key })
      });
      const data = await r.json();
      if (data.ok || data.success) {
        window.location.href = '/dashboard';
      } else {
        alert('Falha ao selecionar: ' + (data.error || 'erro'));
      }
    }

    async function clearAccount() {
      await fetch('/api/account/clear',{ method:'POST' });
      // mant√©m na tela para o usu√°rio escolher outra
      location.reload();
    }

    loadAccounts();
  </script>
</div>
</section>
</main>
<script>
    // Marcar aba ativa
    (function() {
      var tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(function(t) {
        if (t.getAttribute('data-tab') === 'dashboard') t.classList.add('active');
      });
    })();

    // Conta atual + Trocar conta
    const ACCOUNT_LABELS = { drossi: 'DRossi Interiores', diplany: 'Diplany', rossidecor: 'Rossi Decor' };
    async function carregarContaAtual() {
      const currentEl = document.getElementById('account-current');
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        let shown = 'N√£o selecionada';
        if (data && (data.ok || data.success)) {
          shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
        } else if (data) {
          shown = data.label || data.accountKey || 'Desconhecida';
        }
        currentEl.textContent = shown;
      } catch(e) {
        currentEl.textContent = 'Indispon√≠vel';
      }
    }
    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        window.location.href = '/select-conta';
      } catch(e) {
        window.location.href = '/select-conta';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      carregarContaAtual();
      var switchBtn = document.getElementById('account-switch');
      if (switchBtn) switchBtn.addEventListener('click', trocarConta);
    });

    // Status (token)
    function abrirModalStatus() {
      document.getElementById('modal-status').style.display = 'block';
    }
    function fecharModalStatus() {
      document.getElementById('modal-status').style.display = 'none';
    }
    document.getElementById('btn-status').addEventListener('click', async () => {
      abrirModalStatus();
      await verificarToken(true);
    });
    async function verificarToken(updateModal=false) {
      try {
        const response = await fetch('/verificar-token');
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '‚Äî';
            document.getElementById('status-token').textContent = data.token_preview || '‚Äî';
            document.getElementById('status-msg').textContent = data.message || 'OK';
          } else {
            alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nToken: ' + data.token_preview);
          }
        } else {
          if (updateModal) {
            document.getElementById('status-msg').textContent = data.error || 'Falha ao verificar';
          } else {
            alert('‚ùå ' + (data.error || 'Falha ao verificar'));
          }
        }
      } catch (error) {
        if (updateModal) document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        else alert('‚ùå Erro: ' + error.message);
      }
    }
    async function renovarToken(updateModal=false) {
      try {
        const response = await fetch('/renovar-token-automatico', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '‚Äî';
            document.getElementById('status-token').textContent = (data.access_token || '').substring(0, 20) + '...';
            document.getElementById('status-msg').textContent = data.message || 'Token renovado';
          } else {
            alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nNovo token: ' + data.access_token.substring(0, 20) + '...');
          }
        } else {
          if (updateModal) document.getElementById('status-msg').textContent = data.error || 'Falha ao renovar';
          else alert('‚ùå ' + (data.error || 'Falha ao renovar'));
        }
      } catch (error) {
        if (updateModal) document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        else alert('‚ùå Erro: ' + error.message);
      }
    }
    // Fechar modal clicando fora
    window.addEventListener('click', function(event){
      const m2 = document.getElementById('modal-status');
      if (event.target === m2) fecharModalStatus();
    });
  </script>
</body>
</html>