<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/css/dashboard.css?v=2">
  <title>API Mercado Livre - Dashboard</title>
</head>
<body>
  <!-- TOPO: Conta atual + Status + Trocar Conta -->
  <header class="account-bar">
    <div class="account-bar__left">
      <span class="logo">ğŸŸ¡</span>
      <span class="app-name">API Mercado Livre</span>
    </div>
    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="btn-status" class="account-bar__status" title="Ver status do token">Status</button>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">Trocar Conta</button>
    </div>
  </header>

  <!-- NavegaÃ§Ã£o principal com abas -->
  <nav class="main-nav">
    <div class="tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="produtos">Produtos</button>
      <button class="nav-tab" data-tab="ia">IA & Analytics</button>
      <button class="nav-tab" data-tab="publicidade">Publicidade</button>
      <button class="nav-tab" data-tab="benchmarking">Benchmarking</button>
      <button class="nav-tab" data-tab="alertas">Alertas</button>
      <button class="nav-tab" data-tab="ml">ML</button>
      <button class="nav-tab" data-tab="full">FULL</button>
    </div>
  </nav>

  <!-- CONTEÃšDOS DAS ABAS -->
  <main class="page-wrap">
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab-page active">
      <div class="container">
        <h1>ğŸ“Š VisÃ£o Geral</h1>
        <div class="account-context">
          Conta atual: <strong id="account-name-inline">Carregando...</strong>
        </div>
        <p class="subtitle">Seu servidor Node.js estÃ¡ operacional.</p>

        <div class="endpoints">
          <div class="endpoint token">
            <h3>ğŸ”‘ Gerenciar Token <span class="status warning">AtenÃ§Ã£o</span></h3>
            <p>Verifique e renove o ACCESS_TOKEN para manter integraÃ§Ãµes ativas.</p>
            <div class="token-actions">
              <button onclick="verificarToken()">ğŸ” Verificar Token</button>
              <button onclick="renovarToken()">ğŸ”„ Renovar Token</button>
            </div>
          </div>

          <div class="endpoint processos">
            <h3>
              âš™ï¸ Processos em ExecuÃ§Ã£o 
              <span class="status active">Ativo</span>
              <span id="process-counter" class="process-counter" style="display:none;">
                <span id="counter-number">0</span> ativos
              </span>
            </h3>
            <p>Monitore e gerencie todos os processos em massa em tempo real.</p>
            <div class="token-actions">
              <button onclick="abrirModalProcessos()">ğŸ“Š Ver Processos</button>
              <button onclick="iniciarNovoProcesso()">â• Novo Processo</button>
            </div>
          </div>

          <div class="endpoint info full">
            <h3>ğŸ“‹ Funcionalidades DisponÃ­veis</h3>
            <ul class="features">
              <li><strong>ğŸ¯ PromoÃ§Ãµes:</strong> Criar e remover promoÃ§Ãµes</li>
              <li><strong>ğŸ” Pesquisa:</strong> Buscar texto em tÃ­tulos/descriÃ§Ãµes/atributos</li>
              <li><strong>âš™ï¸ Filas:</strong> Processamento em background</li>
              <li><strong>ğŸ“ˆ Keywords:</strong> TendÃªncias e relacionadas</li>
              <li><strong>ğŸ“Š Monitoramento:</strong> Status em tempo real</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

   <!-- PRODUTOS -->
<section id="tab-produtos" class="tab-page">
  <div class="container">
    <h1>ğŸ›ï¸ Produtos</h1>
    <p class="subtitle">AÃ§Ãµes de promoÃ§Ã£o para anÃºncios (MLB).</p>
    <div class="endpoints">

      <div class="endpoint promotion">
        <h3>ğŸ¯ Criar PromoÃ§Ãµes <span class="status active">Ativo</span></h3>
        <p>Crie promoÃ§Ãµes unitÃ¡rias ou em massa com diferentes tipos de campanhas.</p>
        <a href="/criar-promocao">ğŸš€ Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>ğŸ—‘ï¸ Remover PromoÃ§Ãµes <span class="status active">Ativo</span></h3>
        <p>Remova promoÃ§Ãµes de anÃºncios individualmente ou em lote.</p>
        <a href="/remover-promocao">ğŸ”§ Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>ğŸ—‘ï¸ ExclusÃ£o de AnÃºncios <span class="status active">Ativo</span></h3>
        <p>Exclua anÃºncios individualmente ou em lote utilizando MLBs vÃ¡lidos.</p>
        <a href="/excluir-anuncio">ğŸ”§ Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>ğŸ“¦ Validar dimensÃµes <span class="status active">Ativo</span></h3>
        <p>Consulte as dimensÃµes cadastradas nos anÃºncios (MLB) e exporte tudo em CSV.</p>
        <a href="/validar-dimensoes">ğŸ“¦ Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>â­ Produtos EstratÃ©gicos <span class="status active">Novo</span></h3>
        <p>
          Gerencie a lista de anÃºncios estratÃ©gicos por conta, defina percentuais-padrÃ£o
          e aplique promoÃ§Ãµes recorrentes sem usar planilhas externas.
        </p>
        <a href="/estrategicos">â­ Gerenciar EstratÃ©gicos</a>
      </div>

      <!-- âœ… NOVO CARD: Filtro avanÃ§ado -->
      <div class="endpoint">
        <h3>ğŸ§® Filtro AvanÃ§ado de AnÃºncios <span class="status active">Novo</span></h3>
        <p>
          Filtre anÃºncios por perÃ­odo, vendas, status, promo ativa, Ads, visitas, cliques e impressÃµes.
          Visualize em tabela e exporte resultados.
        </p>
        <a href="/filtro-anuncios">ğŸ§® Acessar Interface</a>
      </div>

    </div>
  </div>
</section>

    <!-- IA & ANALYTICS -->
    <section id="tab-ia" class="tab-page">
      <div class="container">
        <h1>ğŸ¤– IA & Analytics</h1>
        <p class="subtitle">Ferramentas de anÃ¡lise de anÃºncios e pesquisa.</p>
        <div class="endpoints">
          <div class="endpoint analysis">
            <h3>ğŸ“ˆ AnÃ¡lise de AnÃºncios <span class="status active">Ativo</span></h3>
            <p>Consulte MLB(s), veja tipo (ClÃ¡ssico/Premium), data de criaÃ§Ã£o e tempo desde a Ãºltima venda. Exporte XLSX.</p>
            <a href="/analise-anuncios">ğŸ“ˆ Acessar AnÃ¡lise</a>
          </div>
          <div class="endpoint search">
            <h3>ğŸ” Pesquisa em DescriÃ§Ãµes <span class="status active">Ativo</span></h3>
            <p>Busque texto especÃ­fico nas descriÃ§Ãµes de mÃºltiplos MLBs.</p>
            <a href="/pesquisa-descricao">ğŸ” Iniciar Pesquisa</a>
          </div>
          <div class="endpoint keyword-analytics">
            <h3>ğŸ§  Palavras-chave & TendÃªncias <span class="status active">Ativo</span></h3>
            <p>Descubra palavras relacionadas e tendÃªncias (simulado).</p>
            <a href="/keyword-analytics">ğŸ“Š Acessar AnÃ¡lise</a>
          </div>

          <!-- Curva ABC -->
          <div class="endpoint curva-abc">
            <h3>ğŸ“Š Curva ABC <span class="status active">Ativo</span></h3>
            <p>Top 5 A/B/C por perÃ­odo e multicontas. Clique nos cards para filtrar.</p>
            <a href="/ia-analytics/curva-abc">ğŸ“Š Acessar Curva ABC</a>
          </div>
        </div>
      </div>
    </section>

    <!-- PUBLICIDADE -->
    <section id="tab-publicidade" class="tab-page">
      <div class="container">
        <h1>ğŸ“£ Publicidade</h1>
        <p class="subtitle">Ferramentas para anÃ¡lise e gestÃ£o das campanhas de Product Ads.</p>

        <div class="endpoints">
          <!-- CARD PRINCIPAL: PRODUCT ADS -->
          <div class="endpoint">
            <h3>ğŸ“Š Product Ads <span class="status active">Ativo</span></h3>
            <p>
              Visualize o ranking de campanhas, mÃ©tricas completas (ACOS, TACOS, cliques, impressÃµes,
              receita, retornos, etc.) e baixe os dados em CSV.
            </p>
            <a href="/publicidade">ğŸš€ Acessar Product Ads</a>
          </div>
        </div>
      </div>
    </section>
    <!-- /PUBLICIDADE -->

    <!-- BENCHMARKING -->
    <section id="tab-benchmarking" class="tab-page">
      <div class="container">
        <h1>ğŸ“Š Benchmarking</h1>
        <p class="subtitle">Em breve: compare desempenho com concorrentes.</p>
        <div class="placeholder">Sem conteÃºdo por enquanto.</div>
      </div>
    </section>

    <!-- ALERTAS -->
    <section id="tab-alertas" class="tab-page">
      <div class="container">
        <h1>ğŸš¨ Alertas</h1>
        <p class="subtitle">Em breve: notificaÃ§Ãµes de estoque, preÃ§o e performance.</p>
        <div class="placeholder">Sem conteÃºdo por enquanto.</div>
      </div>
    </section>

    <!-- ML -->
    <section id="tab-ml" class="tab-page">
      <div class="container">
        <h1>ğŸŸ¡ Mercado Livre</h1>
        <p class="subtitle">InformaÃ§Ãµes da conta e utilitÃ¡rios ML.</p>
        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ§­ Rotas & Debug <span class="status active">Ativo</span></h3>
            <p>Listagem de endpoints e verificaÃ§Ãµes rÃ¡pidas.</p>
            <a href="/debug/routes">ğŸ“Š Ver Rotas</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FULL -->
    <section id="tab-full" class="tab-page">
      <div class="container">
        <h1>ğŸ“¦ FULL</h1>
        <p class="subtitle">Produtos que estÃ£o no fulfillment do Mercado Livre (ML Full).</p>

        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ—‚ï¸ Produtos (Full) <span id="full-status-pill" class="status active">Ativo</span></h3>
            <p>Veja os itens que estÃ£o no centro de fulfillment (estoque, preÃ§o, status, promoÃ§Ãµes ativas).</p>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="mini-stat">
                <strong id="full-total-itens">â€”</strong>
                <small>itens em Full</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-ativos">â€”</strong>
                <small>ativos</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-transf">â€”</strong>
                <small>em transferÃªncia</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-ineleg">â€”</strong>
                <small>inelegÃ­veis</small>
              </span>
            </div>
            <div style="margin-top:12px;">
              <a class="btn-primary" href="/full">ğŸš€ Abrir Produtos (Full)</a>
            </div>
          </div>

          <div class="endpoint">
            <h3>ğŸ“¤ ExportaÃ§Ãµes</h3>
            <p>Gere relatÃ³rios CSV/XLSX dos itens sob Full. (Na pÃ¡gina dedicada, use â€œExportar CSVâ€.)</p>
            <a href="/full">ğŸ“„ Ir para Exportar</a>
          </div>
        </div>

        <div class="placeholder" id="full-hint" style="display:none; margin-top:8px;">
          â„¹ï¸ Dica: caso os totais nÃ£o carreguem, finalize a configuraÃ§Ã£o do endpoint <code>GET /api/full/summary</code>.
        </div>
      </div>
    </section>
    <!-- /FULL -->
  </main>

  <!-- Modal de Processos -->
  <div id="modal-processos" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âš™ï¸ Processos em ExecuÃ§Ã£o</h3>
        <span class="close" onclick="fecharModalProcessos()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="stats-mini" id="stats-processos">
          <div class="stat-mini"><h4 id="total-processando">0</h4><p>Processando</p></div>
          <div class="stat-mini"><h4 id="total-aguardando">0</h4><p>Na Fila</p></div>
          <div class="stat-mini"><h4 id="total-concluidos">0</h4><p>ConcluÃ­dos</p></div>
          <div class="stat-mini"><h4 id="total-erros">0</h4><p>Com Erros</p></div>
        </div>
        <div style="text-align:center; margin:20px 0;">
          <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">â• Novo Processo</button>
          <button class="btn-small btn-warning" onclick="atualizarProcessos()">ğŸ”„ Atualizar</button>
        </div>
        <div id="lista-processos">
          <div style="text-align:center; padding:20px;"><p>ğŸ”„ Carregando processos...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Status (token) -->
  <div id="modal-status" class="modal">
    <div class="modal-content">
      <div class="modal-header alt">
        <h3>ğŸŸ¢ Status da IntegraÃ§Ã£o</h3>
        <span class="close" onclick="fecharModalStatus()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="status-grid">
          <div class="stat-mini"><h4 id="status-usuario">â€”</h4><p>UsuÃ¡rio</p></div>
          <div class="stat-mini"><h4 id="status-token">â€”</h4><p>Token (preview)</p></div>
          <div class="stat-mini"><h4 id="status-msg">â€”</h4><p>Mensagem</p></div>
        </div>
        <div class="modal-controls">
          <button class="btn-small btn-primary" onclick="verificarToken(true)">ğŸ” Verificar</button>
          <button class="btn-small btn-success" onclick="renovarToken(true)">ğŸ”„ Renovar</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ===== Util ===== */
  const $ = (id) => document.getElementById(id);
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

  function safeBind(el, ev, fn) { if (el) el.addEventListener(ev, fn); }
  function show(el) { if (el) el.style.display = 'block'; }
  function hide(el) { if (el) el.style.display = 'none'; }
  function safeAlert(msg) { try { alert(msg); } catch(_) { console.log('ALERT:', msg); } }

  /* ===== Abas ===== */
  function initTabs() {
    const tabs = qsa('.nav-tab');
    const pages = qsa('.tab-page');
    tabs.forEach(btn => {
      safeBind(btn, 'click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        pages.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const id = 'tab-' + btn.dataset.tab;
        const page = $(id);
        if (page) page.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  }

  /* ===== Conta / Trocar conta ===== */
  const ACCOUNT_LABELS = {
    drossi: 'DRossi Interiores',
    diplany: 'Diplany',
    rossidecor: 'Rossi Decor'
  };

  async function carregarContaAtual() {
    const currentEl = $('account-current');
    const inlineEl  = $('account-name-inline');
    try {
      const r = await fetch('/api/account/current', { cache: 'no-store' });
      const data = await r.json();
      let shown = 'NÃ£o selecionada';
      if (data && (data.ok || data.success)) {
        shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
      }
      if (currentEl) currentEl.textContent = shown;
      if (inlineEl)  inlineEl.textContent  = shown;
    } catch(e) {
      if (currentEl) currentEl.textContent = 'IndisponÃ­vel';
      if (inlineEl)  inlineEl.textContent  = 'IndisponÃ­vel';
      console.error('carregarContaAtual:', e);
    }
  }

  async function trocarConta() {
    try {
      await fetch('/api/account/clear', { method: 'POST' });
    } catch (_) { /* ignora */ }
    window.location.href = '/select-conta';
  }

  /* ===== Token / Status ===== */
  function abrirModalStatus() { show($('modal-status')); }
  function fecharModalStatus() { hide($('modal-status')); }

  async function verificarToken(updateModal=false) {
    try {
      const response = await fetch('/verificar-token');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data.success) {
        if (updateModal) {
          const u = $('status-usuario'), t = $('status-token'), m = $('status-msg');
          if (u) u.textContent = data.nickname || 'â€”';
          if (t) t.textContent = data.token_preview || 'â€”';
          if (m) m.textContent = data.message || 'OK';
        } else {
          safeAlert('âœ… ' + (data.message || 'OK') +
            '\nUser: ' + (data.nickname || 'â€”') +
            '\nToken: ' + (data.token_preview || 'â€”'));
        }
      } else {
        const msg = data.error || 'Falha ao verificar';
        if (updateModal) {
          const m = $('status-msg'); if (m) m.textContent = msg;
        } else {
          safeAlert('âŒ ' + msg);
        }
      }
    } catch (error) {
      if (updateModal) {
        const m = $('status-msg'); if (m) m.textContent = 'Erro: ' + error.message;
      } else {
        safeAlert('âŒ Erro: ' + error.message);
      }
    }
  }

  async function renovarToken(updateModal=false) {
    try {
      const response = await fetch('/renovar-token-automatico', { method: 'POST' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data.success) {
        if (updateModal) {
          const u = $('status-usuario'), t = $('status-token'), m = $('status-msg');
          if (u) u.textContent = data.nickname || 'â€”';
          if (t) t.textContent = (data.access_token || '').substring(0, 20) + '...';
          if (m) m.textContent = data.message || 'Token renovado';
        } else {
          safeAlert('âœ… ' + (data.message || 'Token renovado') +
            '\nUser: ' + (data.nickname || 'â€”') +
            '\nNovo token: ' + (data.access_token || '').substring(0, 20) + '...');
        }
      } else {
        const msg = data.error || 'Falha ao renovar';
        if (updateModal) {
          const m = $('status-msg'); if (m) m.textContent = msg;
        } else {
          safeAlert('âŒ ' + msg);
        }
      }
    } catch (error) {
      if (updateModal) {
        const m = $('status-msg'); if (m) m.textContent = 'Erro: ' + error.message;
      } else {
        safeAlert('âŒ Erro: ' + error.message);
      }
    }
  }

  /* ===== Modal Processos ===== */
  let intervalAtualizacao = null;

  function abrirModalProcessos() {
    show($('modal-processos'));
    atualizarProcessos().catch(e => console.error(e));
    if (intervalAtualizacao) clearInterval(intervalAtualizacao);
    intervalAtualizacao = setInterval(
      () => atualizarProcessos().catch(e => console.error(e)),
      5000
    );
  }

  function fecharModalProcessos() {
    hide($('modal-processos'));
    if (intervalAtualizacao) clearInterval(intervalAtualizacao);
    intervalAtualizacao = null;
  }

  async function atualizarProcessos() {
    try {
      const response = await fetch('/api/pesquisa-descricao/jobs?limite=20', { cache:'no-store' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data && (data.success || data.ok)) {
        const stats = data.estatisticas_gerais || data.stats || {};
        atualizarEstatisticas(stats);
        exibirProcessos(data.jobs || []);
        atualizarContadorDashboard(data.jobs || []);
      }
    } catch (error) {
      console.error('atualizarProcessos:', error);
    }
  }

  function atualizarEstatisticas(stats) {
    const set = (id, v) => { const el = $(id); if (el) el.textContent = v; };
    set('total-processando', stats.processando_agora || 0);
    set('total-aguardando',  stats.fila_aguardando   || 0);
    set('total-concluidos',  stats.concluidos_recentes || 0);
    set('total-erros',       stats.falharam_recentes || 0);
  }

  function exibirProcessos(jobs) {
    const container = $('lista-processos');
    if (!container) return;
    if (!jobs || jobs.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px;">
          <p>ğŸ“­ Nenhum processo encontrado</p>
          <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">â• Iniciar Primeiro Processo</button>
        </div>`;
      return;
    }
    container.innerHTML = jobs.map(job => `
      <div class="process-item ${job.status}">
        <div class="process-header">
          <div class="process-title">ğŸ“‹ ${job.job_id || job.id}</div>
          <div class="process-status ${job.status}">${job.status}</div>
        </div>
        <div style="font-size:14px; color:#666; margin:5px 0;">
          ğŸ“Š ${((job.concluidos || 0) + (job.falharam || 0))}/${job.total_mlbs || 0} MLBs processados
          ${job.tempo_decorrido ? `â€¢ â±ï¸ ${job.tempo_decorrido}` : ''}
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${(job.progresso_percentual || 0)}%"></div>
        </div>
        <div class="process-actions">
          <button class="btn-small btn-primary" onclick="verDetalhesProcesso('${job.job_id || job.id}')">ğŸ“Š Detalhes</button>
          ${job.status === 'concluido'
            ? `<a href="/api/pesquisa-descricao/download/${job.job_id || job.id}" class="btn-small btn-success">ğŸ“¥ Download</a>`
            : ''}
          ${(job.status === 'processando' || job.status === 'aguardando')
            ? `<button class="btn-small btn-danger" onclick="cancelarProcesso('${job.job_id || job.id}')">ğŸš« Cancelar</button>`
            : ''}
        </div>
      </div>
    `).join('');
  }

  function atualizarContadorDashboard(jobs) {
    const ativos = (jobs || []).filter(j =>
      j.status === 'processando' || j.status === 'aguardando'
    ).length;
    const counter = $('process-counter');
    const counterNumber = $('counter-number');
    if (!counter || !counterNumber) return;
    if (ativos > 0) {
      counter.style.display = 'inline-flex';
      counter.classList.add('pulsing');
      counterNumber.textContent = String(ativos);
    } else {
      counter.style.display = 'none';
      counter.classList.remove('pulsing');
    }
  }

  function iniciarNovoProcesso() {
    window.location.href = '/pesquisa-descricao?novo_processo=true';
  }

  async function verDetalhesProcesso(jobId) {
    const ctl = new AbortController();
    const timeout = setTimeout(() => ctl.abort(), 10000);

    try {
      const response = await fetch(
        `/api/pesquisa-descricao/status/${encodeURIComponent(jobId)}`,
        { cache: 'no-store', signal: ctl.signal }
      );

      if (!response.ok) {
        const txt = await response.text().catch(() => '');
        throw new Error(`HTTP ${response.status} ${txt || ''}`.trim());
      }

      const data = await response.json();

      if (data && (data.success || data.ok)) {
        const job = data.status || {};
        const progresso = Number(job.progresso_percentual ?? 0);
        const total = Number(job.total_mlbs ?? 0);
        const concluidos = Number(job.concluidos ?? 0);
        const falharam = Number(job.falharam ?? 0);
        const processados = concluidos + falharam;

        const detalhes =
`ğŸ“Š Detalhes do Processo: ${jobId}

Status: ${job.status ?? 'â€”'}
Progresso: ${progresso}% 
Total MLBs: ${total}
Processados: ${processados}
Sucessos: ${concluidos}
Erros: ${falharam}
Tempo decorrido: ${job.tempo_decorrido ?? 'N/A'}${job.tempo_estimado_restante ? `\nTempo restante: ${job.tempo_estimado_restante}` : ''}`;

        safeAlert(detalhes);
      } else {
        const msg = (data && (data.message || data.error)) || 'NÃ£o foi possÃ­vel obter os detalhes.';
        safeAlert('âŒ ' + msg);
      }
    } catch (err) {
      if (err.name === 'AbortError') {
        safeAlert('â±ï¸ Tempo esgotado ao consultar o status. Tente novamente.');
      } else if (err instanceof TypeError) {
        safeAlert('ğŸ“¡ Erro de rede ao consultar o status. Verifique sua conexÃ£o e tente novamente.');
      } else {
        safeAlert('âŒ Erro ao obter detalhes: ' + (err.message || String(err)));
      }
    } finally {
      clearTimeout(timeout);
    }
  }

  async function cancelarProcesso(jobId) {
    if (!confirm(`Tem certeza que deseja cancelar o processo ${jobId}?`)) return;
    try {
      const response = await fetch(
        `/api/pesquisa-descricao/cancelar/${encodeURIComponent(jobId)}`,
        { method: 'POST' }
      );
      const data = await response.json();
      if (data && (data.success || data.ok)) {
        safeAlert('âœ… Processo cancelado com sucesso!');
        atualizarProcessos();
      } else {
        safeAlert('âŒ Erro ao cancelar: ' + (data.message || data.error || 'Falha'));
      }
    } catch (error) {
      safeAlert('âŒ Erro: ' + error.message);
    }
  }

  /* ===== Bind global (para onclick no HTML) ===== */
  Object.assign(window, {
    abrirModalStatus,
    fecharModalStatus,
    verificarToken,
    renovarToken,
    abrirModalProcessos,
    fecharModalProcessos,
    atualizarProcessos,
    verDetalhesProcesso,
    cancelarProcesso,
    iniciarNovoProcesso,
    trocarConta
  });

  /* ===== Listeners estÃ¡ticos ===== */
  function bindStaticListeners() {
    safeBind($('btn-status'), 'click', async () => {
      abrirModalStatus();
      await verificarToken(true);
    });
    safeBind($('account-switch'), 'click', trocarConta);

    // Fechar modais ao clicar fora
    window.addEventListener('click', (event) => {
      const m1 = $('modal-processos');
      const m2 = $('modal-status');
      if (event.target === m1) fecharModalProcessos();
      if (event.target === m2) fecharModalStatus();
    });
  }

  /* ===== Boot ===== */
  document.addEventListener('DOMContentLoaded', () => {
    try {
      initTabs();
      bindStaticListeners();
      carregarContaAtual();
    } catch (e) {
      console.error('Erro na inicializaÃ§Ã£o:', e);
    }
  });
})();
</script>
</body>
</html>
