<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>API Mercado Livre - Dashboard</title>
  <style>
    /* ===== Account Bar (Topo) ===== */
    .account-bar {
      position: fixed; top: 0; left: 0; right: 0; height: 64px;
      padding: 0 16px; display: flex; align-items: center; justify-content: space-between;
      background: rgba(255,255,255,0.9);
      backdrop-filter: saturate(180%) blur(8px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      z-index: 1000;
    }
    .account-bar__left { display: flex; align-items: center; gap: 10px; font-weight: 700; color: #333; }
    .account-bar__left .logo { font-size: 20px; }
    .account-bar__left .app-name { font-size: 14px; opacity: 0.85; }
    .account-bar__right { display: flex; align-items: center; gap: 14px; }
    .account-bar__current {
      display: flex; align-items: center; gap: 6px; font-size: 13px; color: #333;
      background: #f3f4f6; padding: 6px 10px; border-radius: 999px; border: 1px solid #e5e7eb;
    }
    .account-bar__current .lbl { opacity: .75; }
    .account-bar__current .val { font-weight: 700; color: #111827; }
    .account-bar__switch {
      border: 0; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
      background: #667eea; color: #fff; transition: transform .06s ease, box-shadow .2s ease, opacity .2s ease;
      box-shadow: 0 8px 20px rgba(102,126,234,.25);
    }
    .account-bar__switch:hover { opacity: .92; }
    .account-bar__switch:active { transform: translateY(1px); }

    /* ===== P√°gina ===== */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; margin: 0; padding: 80px 20px 20px;
      display: flex; align-items: center; justify-content: center;
    }
    .container {
      background: white; padding: 40px; border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center; max-width: 800px; width: 100%;
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 2.5em; }
    .account-context {
      margin: 0 auto 22px auto; display: inline-flex; align-items: center; gap: 8px;
      font-size: 13px; color: #374151; background: #f3f4f6; padding: 6px 12px;
      border: 1px solid #e5e7eb; border-radius: 999px;
    }
    .account-context strong { color: #111827; }

    .endpoints { display: grid; gap: 15px; margin-top: 30px; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
    .endpoint {
      background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #007bff;
      text-align: left; transition: transform 0.2s, box-shadow 0.2s;
    }
    .endpoint:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .endpoint.new { border-left-color: #28a745; background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%); }
    .endpoint.promotion { border-left-color: #ffc107; background: linear-gradient(135deg, #fffdf7 0%, #fff3cd 100%); }
    .endpoint.search { border-left-color: #17a2b8; background: linear-gradient(135deg, #f7fdff 0%, #d1ecf1 100%); }
    .endpoint.keyword-analytics { border-left-color: #6f42c1; background: linear-gradient(135deg, #f8f7ff 0%, #e7e3ff 100%); }
    .endpoint.processos { border-left-color: #fd7e14; background: linear-gradient(135deg, #fff8f5 0%, #ffe8d6 100%); }
    .endpoint h3 { margin: 0 0 10px 0; color: #333; display: flex; align-items: center; gap: 10px; }
    .endpoint p { margin: 0 0 15px 0; color: #666; line-height: 1.5; }
    .endpoint a, .endpoint button {
      color: #007bff; text-decoration: none; font-weight: 600; background: none; border: none; cursor: pointer;
      font-size: 16px; padding: 8px 16px; border-radius: 5px; transition: background-color 0.2s;
    }
    .endpoint a:hover, .endpoint button:hover { background-color: rgba(0,123,255,0.1); text-decoration: none; }
    .endpoint.new a { color: #28a745; } .endpoint.new a:hover { background-color: rgba(40,167,69,0.1); }
    .endpoint.promotion a { color: #ffc107; } .endpoint.promotion a:hover { background-color: rgba(255,193,7,0.1); }
    .endpoint.search a { color: #17a2b8; } .endpoint.search a:hover { background-color: rgba(23,162,184,0.1); }
    .endpoint.keyword-analytics a { color: #6f42c1; } .endpoint.keyword-analytics a:hover { background-color: rgba(111,66,193,0.1); }
    .endpoint.processos a { color: #fd7e14; } .endpoint.processos a:hover { background-color: rgba(253,126,20,0.1); }

    .status { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-left: 10px; }
    .status.active { background: #d4edda; color: #155724; }
    .status.warning { background: #fff3cd; color: #856404; }
    .status.new { background: #d1ecf1; color: #0c5460; }

    .token-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .feature-highlight {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .process-counter { display: inline-flex; align-items: center; gap: 5px; background: #fd7e14; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 10px; }
    .process-counter.pulsing { animation: pulse-orange 2s infinite; }
    @keyframes pulse-orange { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h3 { margin: 0; display: flex; align-items: center; gap: 10px; }
    .close { color: white; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover { opacity: 0.7; }
    .modal-body { padding: 20px; }

    .stats-mini { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
    .stat-mini { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #007bff; }
    .stat-mini h4 { margin: 0; font-size: 1.5em; color: #333; }
    .stat-mini p { margin: 5px 0 0 0; font-size: 0.9em; color: #666; }

    .process-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; }
    .process-item.processando { border-left-color: #28a745; background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%); }
    .process-item.aguardando { border-left-color: #ffc107; background: linear-gradient(135deg, #fffdf7 0%, #fff3cd 100%); }
    .process-item.concluido { border-left-color: #6c757d; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
    .process-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .process-title { font-weight: 600; color: #333; }
    .process-status { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .process-status.processando { background: #d4edda; color: #155724; }
    .process-status.aguardando { background: #fff3cd; color: #856404; }
    .process-status.concluido { background: #e2e3e5; color: #383d41; }
    .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); transition: width 0.3s ease; }
    .process-actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn-small { padding: 5px 10px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-small:hover { opacity: 0.8; }
  </style>
</head>
<body>

  <!-- TOPO: Conta atual + Trocar Conta -->
  <header class="account-bar">
    <div class="account-bar__left">
      <span class="logo">üîé</span>
      <span class="app-name">API Mercado Livre</span>
    </div>
    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta atual:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">
        Trocar Conta
      </button>
    </div>
  </header>

  <div class="container">
    <h1>üõí API Mercado Livre</h1>
    <div class="account-context">
      Conta atual: <strong id="account-name-inline">Carregando...</strong>
    </div>
    <p>Servidor Node.js rodando com sucesso!</p>

    <div class="endpoints">
      <div class="endpoint">
        <h3>üîë Gerenciar Token <span class="status warning">IMPORTANTE</span></h3>
        <p>Verificar e renovar ACCESS_TOKEN para manter a API funcionando</p>
        <div class="token-actions">
          <button onclick="verificarToken()">üîç Verificar Token</button>
          <button onclick="renovarToken()">üîÑ Renovar Token</button>
        </div>
      </div>

      <div class="endpoint promotion">
        <h3>üéØ Criar Promo√ß√µes <span class="status active">ATIVO</span></h3>
        <p>Crie promo√ß√µes unit√°rias ou em massa com diferentes tipos de campanhas</p>
        <a href="/criar-promocao">üöÄ Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>üóëÔ∏è Remover Promo√ß√µes <span class="status active">ATIVO</span></h3>
        <p>Interface para remover promo√ß√µes de an√∫ncios individuais ou em lote</p>
        <a href="/remover-promocao">üîß Acessar Interface</a>
      </div>

      <div class="endpoint search">
        <h3>
          üîç Pesquisa em Descri√ß√µes 
          <span class="status active">ATIVO</span>
        </h3>
        <p>Pesquise texto espec√≠fico nas descri√ß√µes de m√∫ltiplos MLBs.</p>
        <a href="/pesquisa-descricao">üîé Iniciar Pesquisa</a>
      </div>

      <div class="endpoint processos">
        <h3>
          ‚öôÔ∏è Processos em Execu√ß√£o 
          <span class="feature-highlight">NOVO</span>
          <span class="status active">ATIVO</span>
          <span id="process-counter" class="process-counter" style="display: none;">
            <span id="counter-number">0</span> ativos
          </span>
        </h3>
        <p>Monitore e gerencie todos os processos de pesquisa em massa em tempo real.</p>
        <div class="token-actions">
          <button onclick="abrirModalProcessos()">üìä Ver Processos</button>
          <button onclick="iniciarNovoProcesso()">‚ûï Novo Processo</button>
        </div>
      </div>

      <div class="endpoint keyword-analytics new">
        <h3>
          üìà An√°lise de Palavra-chave e Tend√™ncias 
          <span class="feature-highlight">NOVO</span>
          <span class="status new">BETA</span>
        </h3>
        <p>Descubra palavras relacionadas e tend√™ncias (simulado).</p>
        <a href="/keyword-analytics">üìä Acessar An√°lise</a>
      </div>

      <div class="endpoint">
        <h3>üîß Debug & Monitoramento <span class="status active">ATIVO</span></h3>
        <p>Verificar endpoints dispon√≠veis e status do sistema</p>
        <a href="/debug/routes">üìä Ver Rotas</a>
      </div>

      <div class="endpoint new" style="grid-column: 1 / -1; border-left-color: #6f42c1; background: linear-gradient(135deg, #f8f7ff 0%, #e7e3ff 100%);">
        <h3>üìã Funcionalidades Dispon√≠veis</h3>
        <p><strong>üéØ Promo√ß√µes:</strong> Criar e remover promo√ß√µes</p>
        <p><strong>üîç Pesquisa:</strong> Buscar texto em t√≠tulos/descri√ß√µes/atributos</p>
        <p><strong>‚öôÔ∏è Filas:</strong> Processamento em background</p>
        <p><strong>üìà Keywords:</strong> Tend√™ncias e relacionadas (BETA)</p>
        <p><strong>üìä Monitoramento:</strong> Status em tempo real</p>
      </div>
    </div>
  </div>

  <!-- Modal de Processos -->
  <div id="modal-processos" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚öôÔ∏è Processos em Execu√ß√£o</h3>
        <span class="close" onclick="fecharModalProcessos()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="stats-mini" id="stats-processos">
          <div class="stat-mini"><h4 id="total-processando">0</h4><p>Processando</p></div>
          <div class="stat-mini"><h4 id="total-aguardando">0</h4><p>Na Fila</p></div>
          <div class="stat-mini"><h4 id="total-concluidos">0</h4><p>Conclu√≠dos</p></div>
          <div class="stat-mini"><h4 id="total-erros">0</h4><p>Com Erros</p></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
          <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">‚ûï Novo Processo</button>
          <button class="btn-small btn-warning" onclick="atualizarProcessos()">üîÑ Atualizar</button>
        </div>

        <div id="lista-processos">
          <div style="text-align: center; padding: 20px;">
            <p>üîÑ Carregando processos...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Conta atual / Trocar conta ===== */
    const ACCOUNT_LABELS = { drossi: 'DRossi Interiores', diplany: 'Diplany', rossidecor: 'Rossi Decor' };

    async function carregarContaAtual() {
      const currentEl = document.getElementById('account-current');
      const inlineEl  = document.getElementById('account-name-inline');
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        let shown = 'N√£o selecionada';
        if (data && (data.ok || data.success)) {
          shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
        }
        currentEl.textContent = shown;
        inlineEl.textContent  = shown;
      } catch(e) {
        currentEl.textContent = 'Indispon√≠vel';
        inlineEl.textContent  = 'Indispon√≠vel';
      }
    }

    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        window.location.href = '/select-conta';
      } catch(e) {
        window.location.href = '/select-conta';
      }
    }

    /* ===== Token ===== */
    async function verificarToken() {
      try {
        const response = await fetch('/verificar-token');
        const data = await response.json();
        if (data.success) {
          alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nToken: ' + data.token_preview);
        } else {
          alert('‚ùå ' + (data.error || 'Falha ao verificar'));
        }
      } catch (error) { alert('‚ùå Erro: ' + error.message); }
    }
    async function renovarToken() {
      try {
        const response = await fetch('/renovar-token-automatico', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nNovo token: ' + data.access_token.substring(0, 20) + '...');
        } else {
          alert('‚ùå ' + (data.error || 'Falha ao renovar'));
        }
      } catch (error) { alert('‚ùå Erro: ' + error.message); }
    }

    /* ===== Modal Processos ===== */
    let intervalAtualizacao;

    async function abrirModalProcessos() {
      document.getElementById('modal-processos').style.display = 'block';
      await atualizarProcessos();
      intervalAtualizacao = setInterval(atualizarProcessos, 5000);
    }
    function fecharModalProcessos() {
      document.getElementById('modal-processos').style.display = 'none';
      if (intervalAtualizacao) clearInterval(intervalAtualizacao);
    }

    async function atualizarProcessos() {
      try {
        const response = await fetch('/api/pesquisa-descricao/jobs?limite=20', { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const stats = data.estatisticas_gerais || data.stats || {};
          atualizarEstatisticas(stats);
          exibirProcessos(data.jobs || []);
          atualizarContadorDashboard(data.jobs || []);
        }
      } catch (error) { console.error('Erro ao atualizar processos:', error); }
    }
    function atualizarEstatisticas(stats) {
      document.getElementById('total-processando').textContent = stats.processando_agora || 0;
      document.getElementById('total-aguardando').textContent = stats.fila_aguardando || 0;
      document.getElementById('total-concluidos').textContent = stats.concluidos_recentes || 0;
      document.getElementById('total-erros').textContent = stats.falharam_recentes || 0;
    }
    function exibirProcessos(jobs) {
      const container = document.getElementById('lista-processos');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p>üì≠ Nenhum processo encontrado</p>
            <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">‚ûï Iniciar Primeiro Processo</button>
          </div>`;
        return;
      }
      container.innerHTML = jobs.map(job => `
        <div class="process-item ${job.status}">
          <div class="process-header">
            <div class="process-title">üìã ${job.job_id || job.id}</div>
            <div class="process-status ${job.status}">${job.status}</div>
          </div>
          <div style="font-size: 14px; color: #666; margin: 5px 0;">
            üìä ${((job.concluidos || 0) + (job.falharam || 0))}/${job.total_mlbs || 0} MLBs processados
            ${job.tempo_decorrido ? `‚Ä¢ ‚è±Ô∏è ${job.tempo_decorrido}` : ''}
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width: ${(job.progresso_percentual || 0)}%"></div></div>
          <div class="process-actions">
            <button class="btn-small btn-primary" onclick="verDetalhesProcesso('${job.job_id || job.id}')">üìä Detalhes</button>
            ${job.status === 'concluido' ? `<a href="/api/pesquisa-descricao/download/${job.job_id || job.id}" class="btn-small btn-success">üì• Download</a>` : ''}
            ${(job.status === 'processando' || job.status === 'aguardando') ? `<button class="btn-small btn-danger" onclick="cancelarProcesso('${job.job_id || job.id}')">üö´ Cancelar</button>` : ''}
          </div>
        </div>
      `).join('');
    }
    function atualizarContadorDashboard(jobs) {
      const ativos = (jobs || []).filter(j => j.status === 'processando' || j.status === 'aguardando').length;
      const counter = document.getElementById('process-counter');
      const counterNumber = document.getElementById('counter-number');
      if (ativos > 0) {
        counter.style.display = 'inline-flex';
        counter.classList.add('pulsing');
        counterNumber.textContent = ativos;
      } else {
        counter.style.display = 'none';
        counter.classList.remove('pulsing');
      }
    }
    async function verDetalhesProcesso(jobId) {
      try {
        const response = await fetch(`/api/pesquisa-descricao/status/${jobId}`, { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const job = data.status || {};
          alert(`üìä Detalhes do Processo: ${jobId}
          
Status: ${job.status}
Progresso: ${job.progresso_percentual || 0}%
Total MLBs: ${job.total_mlbs || 0}
Processados: ${(job.concluidos || 0) + (job.falharam || 0)}
Sucessos: ${job.concluidos || 0}
Erros: ${job.falharam || 0}
Tempo decorrido: ${job.tempo_decorrido || 'N/A'}
${job.tempo_estimado_restante ? `Tempo restante: ${job.tempo_estimado_restante}` : ''}`);
        } else {
          alert('‚ùå N√£o foi poss√≠vel obter os detalhes.');
        }
      } catch (error) { alert('‚ùå Erro ao obter detalhes: ' + error.message); }
    }
    async function cancelarProcesso(jobId) {
      if (!confirm(`Tem certeza que deseja cancelar o processo ${jobId}?`)) return;
      try {
        const response = await fetch(`/api/pesquisa-descricao/cancelar/${jobId}`, { method: 'POST' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          alert('‚úÖ Processo cancelado com sucesso!');
          atualizarProcessos();
        } else {
          alert('‚ùå Erro ao cancelar: ' + (data.message || data.error || 'Falha'));
        }
      } catch (error) { alert('‚ùå Erro: ' + error.message); }
    }
    function iniciarNovoProcesso() { window.location.href = '/pesquisa-descricao?novo_processo=true'; }

    // Fechar modal ao clicar fora
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('modal-processos');
      if (event.target === modal) fecharModalProcessos();
    });

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      carregarContaAtual();
      document.getElementById('account-switch').addEventListener('click', trocarConta);
      const newFeatures = document.querySelectorAll('.endpoint.new');
      newFeatures.forEach((feature, index) => {
        setTimeout(() => { feature.style.animation = 'pulse 2s ease-in-out 2'; }, 1000 + (index * 500));
      });
      atualizarProcessos();
    });

    // anima√ß√£o pulse
    const style = document.createElement('style');
    style.textContent = `@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }`;
    document.head.appendChild(style);
  </script>
</body>
</html>
