<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/css/dashboard.css">
  <title>API Mercado Livre - Dashboard</title>
  <!-- Certifique-se de que seu HTML já referencia seu CSS global,
       ex.: <link rel="stylesheet" href="/css/app.css"> -->

</head>
<body>

  <!-- TOPO: Conta atual + Trocar Conta -->
  <header class="account-bar">
    <div class="account-bar__left">
      <span class="logo">🔎</span>
      <span class="app-name">API Mercado Livre</span>
    </div>
    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta atual:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">
        Trocar Conta
      </button>
    </div>
  </header>

  <div class="container">
    <h1>🛒 API Mercado Livre</h1>
    <div class="account-context">
      Conta atual: <strong id="account-name-inline">Carregando...</strong>
    </div>
    <p>Servidor Node.js rodando com sucesso!</p>

    <div class="endpoints">
      <div class="endpoint">
        <h3>🔑 Gerenciar Token <span class="status warning">IMPORTANTE</span></h3>
        <p>Verificar e renovar ACCESS_TOKEN para manter a API funcionando</p>
        <div class="token-actions">
          <button onclick="verificarToken()">🔍 Verificar Token</button>
          <button onclick="renovarToken()">🔄 Renovar Token</button>
        </div>
      </div>

      <div class="endpoint promotion">
        <h3>🎯 Criar Promoções <span class="status active">ATIVO</span></h3>
        <p>Crie promoções unitárias ou em massa com diferentes tipos de campanhas</p>
        <a href="/criar-promocao">🚀 Acessar Interface</a>
      </div>

      <div class="endpoint">
        <h3>🗑️ Remover Promoções <span class="status active">ATIVO</span></h3>
        <p>Interface para remover promoções de anúncios individuais ou em lote</p>
        <a href="/remover-promocao">🔧 Acessar Interface</a>
      </div>

      <!-- NOVO: Card Análise de Anúncios -->
      <div class="endpoint analysis">
        <h3>📈 Análise de Anúncios <span class="status active">ATIVO</span></h3>
        <p>Consulte MLB único ou lista, veja o tipo (Clássico/Premium), “date_created” e “tempo desde a última venda”. Exporte em XLSX.</p>
        <a href="/analise-anuncios">📈 Acessar Análise</a>
      </div>

      <div class="endpoint search">
        <h3>
          🔍 Pesquisa em Descrições 
          <span class="status active">ATIVO</span>
        </h3>
        <p>Pesquise texto específico nas descrições de múltiplos MLBs.</p>
        <a href="/pesquisa-descricao">🔎 Iniciar Pesquisa</a>
      </div>

      <div class="endpoint processos">
        <h3>
          ⚙️ Processos em Execução 
          <span class="status active">ATIVO</span>
          <span id="process-counter" class="process-counter" style="display: none;">
            <span id="counter-number">0</span> ativos
          </span>
        </h3>
        <p>Monitore e gerencie todos os processos de pesquisa em massa em tempo real.</p>
        <div class="token-actions">
          <button onclick="abrirModalProcessos()">📊 Ver Processos</button>
          <button onclick="iniciarNovoProcesso()">➕ Novo Processo</button>
        </div>
      </div>

      <div class="endpoint keyword-analytics">
        <h3>
          📈 Análise de Palavra-chave e Tendências 
          <span class="status active">ATIVO</span>
        </h3>
        <p>Descubra palavras relacionadas e tendências (simulado).</p>
        <a href="/keyword-analytics">📊 Acessar Análise</a>
      </div>

      <div class="endpoint">
        <h3>🔧 Debug & Monitoramento <span class="status active">ATIVO</span></h3>
        <p>Verificar endpoints disponíveis e status do sistema</p>
        <a href="/debug/routes">📊 Ver Rotas</a>
      </div>

      <div class="endpoint" style="grid-column: 1 / -1; border-left-color: #6f42c1; background: linear-gradient(135deg, #f8f7ff 0%, #e7e3ff 100%);">
        <h3>📋 Funcionalidades Disponíveis</h3>
        <p><strong>🎯 Promoções:</strong> Criar e remover promoções</p>
        <p><strong>🔍 Pesquisa:</strong> Buscar texto em títulos/descrições/atributos</p>
        <p><strong>⚙️ Filas:</strong> Processamento em background</p>
        <p><strong>📈 Keywords:</strong> Tendências e relacionadas</p>
        <p><strong>📊 Monitoramento:</strong> Status em tempo real</p>
      </div>
    </div>
  </div>

  <!-- Modal de Processos -->
  <div id="modal-processos" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>⚙️ Processos em Execução</h3>
        <span class="close" onclick="fecharModalProcessos()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="stats-mini" id="stats-processos">
          <div class="stat-mini"><h4 id="total-processando">0</h4><p>Processando</p></div>
          <div class="stat-mini"><h4 id="total-aguardando">0</h4><p>Na Fila</p></div>
          <div class="stat-mini"><h4 id="total-concluidos">0</h4><p>Concluídos</p></div>
          <div class="stat-mini"><h4 id="total-erros">0</h4><p>Com Erros</p></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
          <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">➕ Novo Processo</button>
          <button class="btn-small btn-warning" onclick="atualizarProcessos()">🔄 Atualizar</button>
        </div>

        <div id="lista-processos">
          <div style="text-align: center; padding: 20px;">
            <p>🔄 Carregando processos...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Conta atual / Trocar conta ===== */
    const ACCOUNT_LABELS = { drossi: 'DRossi Interiores', diplany: 'Diplany', rossidecor: 'Rossi Decor' };

    async function carregarContaAtual() {
      const currentEl = document.getElementById('account-current');
      const inlineEl  = document.getElementById('account-name-inline');
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        let shown = 'Não selecionada';
        if (data && (data.ok || data.success)) {
          shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
        }
        currentEl.textContent = shown;
        inlineEl.textContent  = shown;
      } catch(e) {
        currentEl.textContent = 'Indisponível';
        inlineEl.textContent  = 'Indisponível';
      }
    }

    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        window.location.href = '/select-conta';
      } catch(e) {
        window.location.href = '/select-conta';
      }
    }

    /* ===== Token ===== */
    async function verificarToken() {
      try {
        const response = await fetch('/verificar-token');
        const data = await response.json();
        if (data.success) {
          alert('✅ ' + data.message + '\nUser: ' + data.nickname + '\nToken: ' + data.token_preview);
        } else {
          alert('❌ ' + (data.error || 'Falha ao verificar'));
        }
      } catch (error) { alert('❌ Erro: ' + error.message); }
    }
    async function renovarToken() {
      try {
        const response = await fetch('/renovar-token-automatico', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          alert('✅ ' + data.message + '\nUser: ' + data.nickname + '\nNovo token: ' + data.access_token.substring(0, 20) + '...');
        } else {
          alert('❌ ' + (data.error || 'Falha ao renovar'));
        }
      } catch (error) { alert('❌ Erro: ' + error.message); }
    }

    /* ===== Modal Processos ===== */
    let intervalAtualizacao;

    async function abrirModalProcessos() {
      document.getElementById('modal-processos').style.display = 'block';
      await atualizarProcessos();
      intervalAtualizacao = setInterval(atualizarProcessos, 5000);
    }
    function fecharModalProcessos() {
      document.getElementById('modal-processos').style.display = 'none';
      if (intervalAtualizacao) clearInterval(intervalAtualizacao);
    }

    async function atualizarProcessos() {
      try {
        const response = await fetch('/api/pesquisa-descricao/jobs?limite=20', { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const stats = data.estatisticas_gerais || data.stats || {};
          atualizarEstatisticas(stats);
          exibirProcessos(data.jobs || []);
          atualizarContadorDashboard(data.jobs || []);
        }
      } catch (error) { console.error('Erro ao atualizar processos:', error); }
    }
    function atualizarEstatisticas(stats) {
      document.getElementById('total-processando').textContent = stats.processando_agora || 0;
      document.getElementById('total-aguardando').textContent = stats.fila_aguardando || 0;
      document.getElementById('total-concluidos').textContent = stats.concluidos_recentes || 0;
      document.getElementById('total-erros').textContent = stats.falharam_recentes || 0;
    }
    function exibirProcessos(jobs) {
      const container = document.getElementById('lista-processos');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p>📭 Nenhum processo encontrado</p>
            <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">➕ Iniciar Primeiro Processo</button>
          </div>`;
        return;
      }
      container.innerHTML = jobs.map(job => `
        <div class="process-item ${job.status}">
          <div class="process-header">
            <div class="process-title">📋 ${job.job_id || job.id}</div>
            <div class="process-status ${job.status}">${job.status}</div>
          </div>
          <div style="font-size: 14px; color: #666; margin: 5px 0;">
            📊 ${((job.concluidos || 0) + (job.falharam || 0))}/${job.total_mlbs || 0} MLBs processados
            ${job.tempo_decorrido ? `• ⏱️ ${job.tempo_decorrido}` : ''}
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width: ${(job.progresso_percentual || 0)}%"></div></div>
          <div class="process-actions">
            <button class="btn-small btn-primary" onclick="verDetalhesProcesso('${job.job_id || job.id}')">📊 Detalhes</button>
            ${job.status === 'concluido' ? `<a href="/api/pesquisa-descricao/download/${job.job_id || job.id}" class="btn-small btn-success">📥 Download</a>` : ''}
            ${(job.status === 'processando' || job.status === 'aguardando') ? `<button class="btn-small btn-danger" onclick="cancelarProcesso('${job.job_id || job.id}')">🚫 Cancelar</button>` : ''}
          </div>
        </div>
      `).join('');
    }
    function atualizarContadorDashboard(jobs) {
      const ativos = (jobs || []).filter(j => j.status === 'processando' || j.status === 'aguardando').length;
      const counter = document.getElementById('process-counter');
      const counterNumber = document.getElementById('counter-number');
      if (ativos > 0) {
        counter.style.display = 'inline-flex';
        counter.classList.add('pulsing');
        counterNumber.textContent = ativos;
      } else {
        counter.style.display = 'none';
        counter.classList.remove('pulsing');
      }
    }
    async function verDetalhesProcesso(jobId) {
      try {
        const response = await fetch(`/api/pesquisa-descricao/status/${jobId}`, { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const job = data.status || {};
          alert(`📊 Detalhes do Processo: ${jobId}
          
Status: ${job.status}
Progresso: ${job.progresso_percentual || 0}%
Total MLBs: ${job.total_mlbs || 0}
Processados: ${(job.concluidos || 0) + (job.falharam || 0)}
Sucessos: ${job.concluidos || 0}
Erros: ${job.falharam || 0}
Tempo decorrido: ${job.tempo_decorrido || 'N/A'}
${job.tempo_estimado_restante ? `Tempo restante: ${job.tempo_estimado_restante}` : ''}`);
        } else {
          alert('❌ Não foi possível obter os detalhes.');
        }
      } catch (error) { alert('❌ Erro ao obter detalhes: ' + error.message); }
    }
    async function cancelarProcesso(jobId) {
      if (!confirm(`Tem certeza que deseja cancelar o processo ${jobId}?`)) return;
      try {
        const response = await fetch(`/api/pesquisa-descricao/cancelar/${jobId}`, { method: 'POST' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          alert('✅ Processo cancelado com sucesso!');
          atualizarProcessos();
        } else {
          alert('❌ Erro ao cancelar: ' + (data.message || data.error || 'Falha'));
        }
      } catch (error) { alert('❌ Erro: ' + error.message); }
    }
    function iniciarNovoProcesso() { window.location.href = '/pesquisa-descricao?novo_processo=true'; }

    // Fechar modal ao clicar fora
    window.addEventListener('click', (event) => {
      const modal = document.getElementById('modal-processos');
      if (event.target === modal) fecharModalProcessos();
    });

    // Boot
    document.addEventListener('DOMContentLoaded', () => {
      carregarContaAtual();
      document.getElementById('account-switch').addEventListener('click', trocarConta);
      atualizarProcessos();
    });

    // animação pulse
    const style = document.createElement('style');
    style.textContent = `@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }`;
    document.head.appendChild(style);
  </script>
</body>
</html>
