
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/css/dashboard.css">
  <title>API Mercado Livre - Dashboard</title>
</head>
<body>
  <!-- TOPO: Conta atual + Status + Trocar Conta -->
  <header class="account-bar">
    <div class="account-bar__left">
      <span class="logo">🟡</span>
      <span class="app-name">API Mercado Livre</span>
    </div>
    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="btn-status" class="account-bar__status" title="Ver status do token">Status</button>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">Trocar Conta</button>
    </div>
  </header>

  <!-- Navegação principal com abas -->
  <nav class="main-nav">
    <div class="tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="produtos">Produtos</button>
      <button class="nav-tab" data-tab="ia">IA & Analytics</button>
      <button class="nav-tab" data-tab="benchmarking">Benchmarking</button>
      <button class="nav-tab" data-tab="alertas">Alertas</button>
      <button class="nav-tab" data-tab="ml">ML</button>
    </div>
  </nav>

  <!-- CONTEÚDOS DAS ABAS -->
  <main class="page-wrap">
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab-page active">
      <div class="container">
        <h1>📊 Visão Geral</h1>
        <div class="account-context">
          Conta atual: <strong id="account-name-inline">Carregando...</strong>
        </div>
        <p class="subtitle">Seu servidor Node.js está operacional.</p>

        <div class="endpoints">
          <div class="endpoint token">
            <h3>🔑 Gerenciar Token <span class="status warning">Atenção</span></h3>
            <p>Verifique e renove o ACCESS_TOKEN para manter integrações ativas.</p>
            <div class="token-actions">
              <button onclick="verificarToken()">🔍 Verificar Token</button>
              <button onclick="renovarToken()">🔄 Renovar Token</button>
            </div>
          </div>

          <div class="endpoint processos">
            <h3>
              ⚙️ Processos em Execução 
              <span class="status active">Ativo</span>
              <span id="process-counter" class="process-counter" style="display:none;">
                <span id="counter-number">0</span> ativos
              </span>
            </h3>
            <p>Monitore e gerencie todos os processos em massa em tempo real.</p>
            <div class="token-actions">
              <button onclick="abrirModalProcessos()">📊 Ver Processos</button>
              <button onclick="iniciarNovoProcesso()">➕ Novo Processo</button>
            </div>
          </div>

          <div class="endpoint info full">
            <h3>📋 Funcionalidades Disponíveis</h3>
            <ul class="features">
              <li><strong>🎯 Promoções:</strong> Criar e remover promoções</li>
              <li><strong>🔍 Pesquisa:</strong> Buscar texto em títulos/descrições/atributos</li>
              <li><strong>⚙️ Filas:</strong> Processamento em background</li>
              <li><strong>📈 Keywords:</strong> Tendências e relacionadas</li>
              <li><strong>📊 Monitoramento:</strong> Status em tempo real</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="tab-produtos" class="tab-page">
      <div class="container">
        <h1>🛍️ Produtos</h1>
        <p class="subtitle">Ações de promoção para anúncios (MLB).</p>
        <div class="endpoints">
          <div class="endpoint promotion">
            <h3>🎯 Criar Promoções <span class="status active">Ativo</span></h3>
            <p>Crie promoções unitárias ou em massa com diferentes tipos de campanhas.</p>
            <a href="/criar-promocao">🚀 Acessar Interface</a>
          </div>
          <div class="endpoint">
            <h3>🗑️ Remover Promoções <span class="status active">Ativo</span></h3>
            <p>Remova promoções de anúncios individualmente ou em lote.</p>
            <a href="/remover-promocao">🔧 Acessar Interface</a>
          </div>
        </div>
      </div>
    </section>

    <!-- IA & ANALYTICS -->
    <section id="tab-ia" class="tab-page">
      <div class="container">
        <h1>🤖 IA & Analytics</h1>
        <p class="subtitle">Ferramentas de análise de anúncios e pesquisa.</p>
        <div class="endpoints">
          <div class="endpoint analysis">
            <h3>📈 Análise de Anúncios <span class="status active">Ativo</span></h3>
            <p>Consulte MLB(s), veja tipo (Clássico/Premium), data de criação e tempo desde a última venda. Exporte XLSX.</p>
            <a href="/analise-anuncios">📈 Acessar Análise</a>
          </div>
          <div class="endpoint search">
            <h3>🔎 Pesquisa em Descrições <span class="status active">Ativo</span></h3>
            <p>Busque texto específico nas descrições de múltiplos MLBs.</p>
            <a href="/pesquisa-descricao">🔍 Iniciar Pesquisa</a>
          </div>
          <div class="endpoint keyword-analytics">
            <h3>🧠 Palavras‑chave & Tendências <span class="status active">Ativo</span></h3>
            <p>Descubra palavras relacionadas e tendências (simulado).</p>
            <a href="/keyword-analytics">📊 Acessar Análise</a>
          </div>
        </div>
      </div>
    </section>

    <!-- BENCHMARKING -->
    <section id="tab-benchmarking" class="tab-page">
      <div class="container">
        <h1>📊 Benchmarking</h1>
        <p class="subtitle">Em breve: compare desempenho com concorrentes.</p>
        <div class="placeholder">Sem conteúdo por enquanto.</div>
      </div>
    </section>

    <!-- ALERTAS -->
    <section id="tab-alertas" class="tab-page">
      <div class="container">
        <h1>🚨 Alertas</h1>
        <p class="subtitle">Em breve: notificações de estoque, preço e performance.</p>
        <div class="placeholder">Sem conteúdo por enquanto.</div>
      </div>
    </section>

    <!-- ML -->
    <section id="tab-ml" class="tab-page">
      <div class="container">
        <h1>🟡 Mercado Livre</h1>
        <p class="subtitle">Informações da conta e utilitários ML.</p>
        <div class="endpoints">
          <div class="endpoint">
            <h3>🧭 Rotas & Debug <span class="status active">Ativo</span></h3>
            <p>Listagem de endpoints e verificações rápidas.</p>
            <a href="/debug/routes">📊 Ver Rotas</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal de Processos -->
  <div id="modal-processos" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>⚙️ Processos em Execução</h3>
        <span class="close" onclick="fecharModalProcessos()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="stats-mini" id="stats-processos">
          <div class="stat-mini"><h4 id="total-processando">0</h4><p>Processando</p></div>
          <div class="stat-mini"><h4 id="total-aguardando">0</h4><p>Na Fila</p></div>
          <div class="stat-mini"><h4 id="total-concluidos">0</h4><p>Concluídos</p></div>
          <div class="stat-mini"><h4 id="total-erros">0</h4><p>Com Erros</p></div>
        </div>
        <div style="text-align:center; margin:20px 0;">
          <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">➕ Novo Processo</button>
          <button class="btn-small btn-warning" onclick="atualizarProcessos()">🔄 Atualizar</button>
        </div>
        <div id="lista-processos">
          <div style="text-align:center; padding:20px;"><p>🔄 Carregando processos...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Status (token) -->
  <div id="modal-status" class="modal">
    <div class="modal-content">
      <div class="modal-header alt">
        <h3>🟢 Status da Integração</h3>
        <span class="close" onclick="fecharModalStatus()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="status-grid">
          <div class="stat-mini"><h4 id="status-usuario">—</h4><p>Usuário</p></div>
          <div class="stat-mini"><h4 id="status-token">—</h4><p>Token (preview)</p></div>
          <div class="stat-mini"><h4 id="status-msg">—</h4><p>Mensagem</p></div>
        </div>
        <div class="modal-controls">
          <button class="btn-small btn-primary" onclick="verificarToken(true)">🔍 Verificar</button>
          <button class="btn-small btn-success" onclick="renovarToken(true)">🔄 Renovar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== Abas ===== */
    const tabs = document.querySelectorAll('.nav-tab');
    const pages = document.querySelectorAll('.tab-page');
    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        pages.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const id = 'tab-' + btn.dataset.tab;
        document.getElementById(id).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    /* ===== Conta / Trocar conta ===== */
    const ACCOUNT_LABELS = { drossi: 'DRossi Interiores', diplany: 'Diplany', rossidecor: 'Rossi Decor' };
    async function carregarContaAtual() {
      const currentEl = document.getElementById('account-current');
      const inlineEl  = document.getElementById('account-name-inline');
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        let shown = 'Não selecionada';
        if (data && (data.ok || data.success)) {
          shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
        }
        currentEl.textContent = shown;
        inlineEl.textContent  = shown;
      } catch(e) {
        currentEl.textContent = 'Indisponível';
        inlineEl.textContent  = 'Indisponível';
      }
    }
    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        window.location.href = '/select-conta';
      } catch(e) {
        window.location.href = '/select-conta';
      }
    }
    document.getElementById('account-switch').addEventListener('click', trocarConta);

    /* ===== Token / Status ===== */
    function abrirModalStatus() {
      document.getElementById('modal-status').style.display = 'block';
    }
    function fecharModalStatus() {
      document.getElementById('modal-status').style.display = 'none';
    }
    document.getElementById('btn-status').addEventListener('click', async () => {
      abrirModalStatus();
      await verificarToken(true);
    });

    async function verificarToken(updateModal=false) {
      try {
        const response = await fetch('/verificar-token');
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '—';
            document.getElementById('status-token').textContent = data.token_preview || '—';
            document.getElementById('status-msg').textContent = data.message || 'OK';
          } else {
            alert('✅ ' + data.message + '\nUser: ' + data.nickname + '\nToken: ' + data.token_preview);
          }
        } else {
          if (updateModal) {
            document.getElementById('status-msg').textContent = data.error || 'Falha ao verificar';
          } else {
            alert('❌ ' + (data.error || 'Falha ao verificar'));
          }
        }
      } catch (error) { 
        if (updateModal) {
          document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        } else {
          alert('❌ Erro: ' + error.message); 
        }
      }
    }

    async function renovarToken(updateModal=false) {
      try {
        const response = await fetch('/renovar-token-automatico', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '—';
            document.getElementById('status-token').textContent = (data.access_token || '').substring(0, 20) + '...';
            document.getElementById('status-msg').textContent = data.message || 'Token renovado';
          } else {
            alert('✅ ' + data.message + '\nUser: ' + data.nickname + '\nNovo token: ' + data.access_token.substring(0, 20) + '...');
          }
        } else {
          if (updateModal) {
            document.getElementById('status-msg').textContent = data.error || 'Falha ao renovar';
          } else {
            alert('❌ ' + (data.error || 'Falha ao renovar'));
          }
        }
      } catch (error) { 
        if (updateModal) {
          document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        } else {
          alert('❌ Erro: ' + error.message); 
        }
      }
    }

    /* ===== Modal Processos ===== */
    let intervalAtualizacao;
    async function abrirModalProcessos() {
      document.getElementById('modal-processos').style.display = 'block';
      await atualizarProcessos();
      intervalAtualizacao = setInterval(atualizarProcessos, 5000);
    }
    function fecharModalProcessos() {
      document.getElementById('modal-processos').style.display = 'none';
      if (intervalAtualizacao) clearInterval(intervalAtualizacao);
    }
    async function atualizarProcessos() {
      try {
        const response = await fetch('/api/pesquisa-descricao/jobs?limite=20', { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const stats = data.estatisticas_gerais || data.stats || {};
          atualizarEstatisticas(stats);
          exibirProcessos(data.jobs || []);
          atualizarContadorDashboard(data.jobs || []);
        }
      } catch (error) { console.error('Erro ao atualizar processos:', error); }
    }
    function atualizarEstatisticas(stats) {
      document.getElementById('total-processando').textContent = stats.processando_agora || 0;
      document.getElementById('total-aguardando').textContent = stats.fila_aguardando || 0;
      document.getElementById('total-concluidos').textContent = stats.concluidos_recentes || 0;
      document.getElementById('total-erros').textContent = stats.falharam_recentes || 0;
    }
    function exibirProcessos(jobs) {
      const container = document.getElementById('lista-processos');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:40px;">
            <p>📭 Nenhum processo encontrado</p>
            <button class="btn-small btn-primary" onclick="iniciarNovoProcesso()">➕ Iniciar Primeiro Processo</button>
          </div>`;
        return;
      }
      container.innerHTML = jobs.map(job => `
        <div class="process-item ${job.status}">
          <div class="process-header">
            <div class="process-title">📋 ${job.job_id || job.id}</div>
            <div class="process-status ${job.status}">${job.status}</div>
          </div>
          <div style="font-size:14px; color:#666; margin:5px 0;">
            📊 ${((job.concluidos || 0) + (job.falharam || 0))}/${job.total_mlbs || 0} MLBs processados
            ${job.tempo_decorrido ? `• ⏱️ ${job.tempo_decorrido}` : ''}
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${(job.progresso_percentual || 0)}%"></div></div>
          <div class="process-actions">
            <button class="btn-small btn-primary" onclick="verDetalhesProcesso('${job.job_id || job.id}')">📊 Detalhes</button>
            ${job.status === 'concluido' ? `<a href="/api/pesquisa-descricao/download/${job.job_id || job.id}" class="btn-small btn-success">📥 Download</a>` : ''}
            ${(job.status === 'processando' || job.status === 'aguardando') ? `<button class="btn-small btn-danger" onclick="cancelarProcesso('${job.job_id || job.id}')">🚫 Cancelar</button>` : ''}
          </div>
        </div>
      `).join('');
    }
    function atualizarContadorDashboard(jobs) {
      const ativos = (jobs || []).filter(j => j.status === 'processando' || j.status === 'aguardando').length;
      const counter = document.getElementById('process-counter');
      const counterNumber = document.getElementById('counter-number');
      if (ativos > 0) {
        counter.style.display = 'inline-flex';
        counter.classList.add('pulsing');
        counterNumber.textContent = ativos;
      } else {
        counter.style.display = 'none';
        counter.classList.remove('pulsing');
      }
    }
    async function verDetalhesProcesso(jobId) {
      try {
        const response = await fetch(`/api/pesquisa-descricao/status/${jobId}`, { cache:'no-store' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          const job = data.status || {};
          alert(`📊 Detalhes do Processo: ${jobId}

Status: ${job.status}
Progresso: ${job.progresso_percentual || 0}%
Total MLBs: ${job.total_mlbs || 0}
Processados: ${(job.concluidos || 0) + (job.falharam || 0)}
Sucessos: ${job.concluidos || 0}
Erros: ${job.falharam || 0}
Tempo decorrido: ${job.tempo_decorrido || 'N/A'}
${job.tempo_estimado_restante ? `Tempo restante: ${job.tempo_estimado_restante}` : ''}`);
        } else {
          alert('❌ Não foi possível obter os detalhes.');
        }
      } catch (error) { alert('❌ Erro ao obter detalhes: ' + error.message); }
    }
    async function cancelarProcesso(jobId) {
      if (!confirm(`Tem certeza que deseja cancelar o processo ${jobId}?`)) return;
      try {
        const response = await fetch(`/api/pesquisa-descricao/cancelar/${jobId}`, { method: 'POST' });
        const data = await response.json();
        if (data && (data.success || data.ok)) {
          alert('✅ Processo cancelado com sucesso!');
          atualizarProcessos();
        } else {
          alert('❌ Erro ao cancelar: ' + (data.message || data.error || 'Falha'));
        }
      } catch (error) { alert('❌ Erro: ' + error.message); }
    }
    function iniciarNovoProcesso() { window.location.href = '/pesquisa-descricao?novo_processo=true'; }

    // fechar modais ao clicar fora
    window.addEventListener('click', (event) => {
      const m1 = document.getElementById('modal-processos');
      const m2 = document.getElementById('modal-status');
      if (event.target === m1) fecharModalProcessos();
      if (event.target === m2) fecharModalStatus();
    });

    // boot
    document.addEventListener('DOMContentLoaded', () => {
      carregarContaAtual();
    });
  </script>
</body>
</html>
