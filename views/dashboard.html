<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/css/dashboard.css?v=2">
  <title>API Mercado Livre - Dashboard</title>
</head>
<body>
  <!-- TOPO: Conta atual + Status + Trocar Conta -->
  <header class="account-bar">
    <div class="account-bar__left">
      <a class="brand" href="/dashboard" aria-label="DAVANTTI">
        <img
          src="/img/davantti.png"
          alt="DAVANTTI"
          class="brand__logo"
          width="170"
          height="42"
          decoding="async"
          loading="eager"
        />
      </a>
    </div>

    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="btn-status" class="account-bar__status" title="Ver status do token">Status</button>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">Trocar Conta</button>
    </div>
  </header>

  <!-- NavegaÃ§Ã£o principal com abas -->
  <nav class="main-nav">
    <div class="tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="anuncios">AnÃºncios</button>
      <button class="nav-tab" data-tab="produtos">Produtos</button>
      <button class="nav-tab" data-tab="ia">IA & Analytics</button>
      <button class="nav-tab" data-tab="publicidade">Publicidade</button>
      <button class="nav-tab" data-tab="benchmarking">Benchmarking</button>
      <button class="nav-tab" data-tab="alertas">Alertas</button>
      <button class="nav-tab" data-tab="ml">ML</button>
      <button class="nav-tab" data-tab="full">FULL</button>
      <button class="nav-tab" data-tab="admin">Admin</button>
    </div>
  </nav>

  <!-- CONTEÃšDOS DAS ABAS -->
  <main class="page-wrap">
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="tab-page active">
      <div class="container">
        <div class="dash-head">
          <h1 class="dash-title">ğŸ“ˆ Dashboard â€” ProjeÃ§Ã£o do MÃªs</h1>
          <div class="account-context">
            Conta atual: <strong id="account-name-inline">Carregando...</strong>
          </div>
          <p class="dash-subtitle">
            Total do mÃªs (todas as vendas) + Ads (atribuÃ­do) + OrgÃ¢nico (estimado) e projeÃ§Ã£o baseada no ritmo atual.
          </p>

          <div class="dash-actions">
            <span class="dash-chip">
              <span class="chip-label">PerÃ­odo:</span>
              <span id="dash-period" class="chip-value">â€”</span>
            </span>

            <span class="dash-chip">
              <span class="chip-label">Dia:</span>
              <span id="dash-day" class="chip-value">â€”</span>
            </span>

            <button id="dash-refresh" class="btn-primary" type="button">ğŸ”„ Atualizar</button>
          </div>
        </div>

        <div id="dash-alert" style="display:none;"></div>

        <!-- Cards principais -->
        <div class="dash-grid">
          <div class="dash-card dash-card--highlight">
            <div class="dash-card__top">
              <div class="dash-card__label">Vendas do mÃªs (Total)</div>
              <span class="pill pill-live">LIVE</span>
            </div>
            <div id="dash-total" class="dash-card__value">â€”</div>
            <div class="dash-card__meta">SomatÃ³rio de pedidos pagos no mÃªs.</div>
          </div>

          <div class="dash-card dash-card--highlight">
            <div class="dash-card__top">
              <div class="dash-card__label">ProjeÃ§Ã£o do mÃªs</div>
              <span class="pill pill-soft" id="dash-proj-pill">estimada</span>
            </div>
            <div id="dash-projected" class="dash-card__value">â€”</div>
            <div class="dash-card__meta">Base: (Total MTD Ã· dia atual) Ã— dias do mÃªs</div>
          </div>

          <div class="dash-card">
            <div class="dash-card__top">
              <div class="dash-card__label">Ads (atribuÃ­do)</div>
              <span class="pill pill-soft" id="dash-ads-pill">â€”</span>
            </div>
            <div id="dash-ads" class="dash-card__value">â€”</div>
            <div class="dash-card__meta">Vendas atribuÃ­das ao Mercado Ads (quando disponÃ­vel).</div>
          </div>

          <div class="dash-card">
            <div class="dash-card__top">
              <div class="dash-card__label">OrgÃ¢nico (estimado)</div>
              <span class="pill pill-soft">estimado</span>
            </div>
            <div id="dash-organic" class="dash-card__value">â€”</div>
            <div class="dash-card__meta">Estimativa: Total âˆ’ Ads (atribuÃ­do).</div>
          </div>
        </div>

        <!-- Progresso do mÃªs -->
        <div class="dash-panel">
          <div class="dash-panel__head">
            <div>
              <h3 class="dash-panel__title">ğŸ“Š Ritmo do mÃªs (dia a dia)</h3>
              <div class="dash-panel__subtitle">Barras: vendas por dia â€¢ Hoje em verde â€¢ Dias futuros em cinza</div>
            </div>
            <span class="dash-chip">
              <span class="chip-label">MÃ©dia/dia:</span>
              <span id="dash-avg" class="chip-value">â€”</span>
            </span>
          </div>

          <div class="dash-progress">
            <div class="dash-progress__bar">
              <div id="dash-progress-fill" class="dash-progress__fill"></div>
            </div>
            <div id="dash-progress-meta" class="dash-progress__meta">â€”</div>
          </div>

          <div class="spark-wrap">
            <div id="dash-sparkline" class="sparkline"></div>
            <div id="dash-spark-empty" class="spark-empty" style="display:none;">
              Sem dados suficientes ainda pra montar o grÃ¡fico ğŸ˜­
            </div>
          </div>

          <div class="dash-panel__foot">
            <div class="formula-box">
              <div class="formula-box__title">ğŸ§® FÃ³rmula usada</div>
              <div class="formula-box__line">
                <code>( total_vendas_mÃªs_atual / dia_atual ) Ã— dias_do_mÃªs</code>
              </div>
              <div id="dash-formula-hint" class="formula-box__hint">â€”</div>
            </div>

            <div class="mini-kpis">
              <div class="mini-kpi">
                <span class="mini-kpi__label">Pedidos (mÃªs)</span>
                <span id="dash-orders" class="mini-kpi__value">â€”</span>
              </div>
              <div class="mini-kpi">
                <span class="mini-kpi__label">Unidades (mÃªs)</span>
                <span id="dash-units" class="mini-kpi__value">â€”</span>
              </div>
              <div class="mini-kpi">
                <span class="mini-kpi__label">Ticket mÃ©dio</span>
                <span id="dash-ticket" class="mini-kpi__value">â€”</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- âœ… ANÃšNCIOS -->
    <section id="tab-anuncios" class="tab-page">
      <div class="container">
        <h1>ğŸ§¾ AnÃºncios</h1>
        <p class="subtitle">Ferramentas focadas em diagnÃ³stico e anÃ¡lise de anÃºncios.</p>

        <div class="endpoints">
          <div class="endpoint">
            <h3>âœï¸ Editar AnÃºncio <span class="status active">Ativo</span></h3>
            <p>
              Carregue um MLB, rode diagnÃ³stico de permissÃµes e prepare a base para testar conteÃºdo enriquecido
              (ex.: descriÃ§Ã£o v2 / PDP).
            </p>
            <a href="/editar-anuncio">âœï¸ Acessar Editor</a>
          </div>

          <div class="endpoint">
            <h3>ğŸ“Š AnÃ¡lise de AnÃºncio (IA) <span class="status active">Ativo</span></h3>
            <p>
              Pesquise um MLB e veja os dados no estilo â€œpÃ¡gina do MLâ€: vendidos, estoque, visitas (janela),
              premium, catÃ¡logo, frete (CEP), vendedor e reputaÃ§Ã£o.
            </p>
            <a href="/analise-ia">ğŸ“Š Abrir AnÃ¡lise (IA)</a>
          </div>
        </div>
      </div>
    </section>

    <!-- PRODUTOS -->
    <section id="tab-produtos" class="tab-page">
      <div class="container">
        <h1>ğŸ›ï¸ Produtos</h1>
        <p class="subtitle">AÃ§Ãµes de promoÃ§Ã£o para anÃºncios (MLB).</p>
        <div class="endpoints">

          <div class="endpoint promotion">
            <h3>ğŸ¯ Criar PromoÃ§Ãµes <span class="status active">Ativo</span></h3>
            <p>Crie promoÃ§Ãµes unitÃ¡rias ou em massa com diferentes tipos de campanhas.</p>
            <a href="/criar-promocao">ğŸš€ Acessar Interface</a>
          </div>

          <div class="endpoint">
            <h3>ğŸ—‘ï¸ Remover PromoÃ§Ãµes <span class="status active">Ativo</span></h3>
            <p>Remova promoÃ§Ãµes de anÃºncios individualmente ou em lote.</p>
            <a href="/remover-promocao">ğŸ”§ Acessar Interface</a>
          </div>

          <div class="endpoint">
            <h3>ğŸ—‘ï¸ ExclusÃ£o de AnÃºncios <span class="status active">Ativo</span></h3>
            <p>Exclua anÃºncios individualmente ou em lote utilizando MLBs vÃ¡lidos.</p>
            <a href="/excluir-anuncio">ğŸ”§ Acessar Interface</a>
          </div>

          <div class="endpoint">
            <h3>ğŸ“¦ Validar dimensÃµes <span class="status active">Ativo</span></h3>
            <p>Consulte as dimensÃµes cadastradas nos anÃºncios (MLB) e exporte tudo em CSV.</p>
            <a href="/validar-dimensoes">ğŸ“¦ Acessar Interface</a>
          </div>

          <div class="endpoint">
            <h3>â­ Produtos EstratÃ©gicos <span class="status active">Novo</span></h3>
            <p>
              Gerencie a lista de anÃºncios estratÃ©gicos por conta, defina percentuais-padrÃ£o
              e aplique promoÃ§Ãµes recorrentes sem usar planilhas externas.
            </p>
            <a href="/estrategicos">â­ Gerenciar EstratÃ©gicos</a>
          </div>

          <div class="endpoint">
            <h3>ğŸ§® Filtro AvanÃ§ado de AnÃºncios <span class="status active">Novo</span></h3>
            <p>
              Filtre anÃºncios por perÃ­odo, vendas, status, promo ativa, Ads, visitas, cliques e impressÃµes.
              Visualize em tabela e exporte resultados.
            </p>
            <a href="/filtro-anuncios">ğŸ§® Acessar Interface</a>
          </div>

        </div>
      </div>
    </section>

    <!-- IA & ANALYTICS -->
    <section id="tab-ia" class="tab-page">
      <div class="container">
        <h1>ğŸ¤– IA & Analytics</h1>
        <p class="subtitle">Ferramentas de anÃ¡lise e pesquisa.</p>
        <div class="endpoints">
          <div class="endpoint search">
            <h3>ğŸ” Pesquisa em DescriÃ§Ãµes <span class="status active">Ativo</span></h3>
            <p>Busque texto especÃ­fico nas descriÃ§Ãµes de mÃºltiplos MLBs.</p>
            <a href="/pesquisa-descricao">ğŸ” Iniciar Pesquisa</a>
          </div>

          <div class="endpoint keyword-analytics">
            <h3>ğŸ§  Palavras-chave & TendÃªncias <span class="status active">Ativo</span></h3>
            <p>Descubra palavras relacionadas e tendÃªncias (simulado).</p>
            <a href="/keyword-analytics">ğŸ“Š Acessar AnÃ¡lise</a>
          </div>

          <div class="endpoint curva-abc">
            <h3>ğŸ“Š Curva ABC <span class="status active">Ativo</span></h3>
            <p>Top 5 A/B/C por perÃ­odo e multicontas. Clique nos cards para filtrar.</p>
            <a href="/ia-analytics/curva-abc">ğŸ“Š Acessar Curva ABC</a>
          </div>
        </div>
      </div>
    </section>

    <!-- PUBLICIDADE -->
    <section id="tab-publicidade" class="tab-page">
      <div class="container">
        <h1>ğŸ“£ Publicidade</h1>
        <p class="subtitle">Ferramentas para anÃ¡lise e gestÃ£o das campanhas de Product Ads.</p>

        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ“Š Product Ads <span class="status active">Ativo</span></h3>
            <p>
              Visualize o ranking de campanhas, mÃ©tricas completas (ACOS, TACOS, cliques, impressÃµes,
              receita, retornos, etc.) e baixe os dados em CSV.
            </p>
            <a href="/publicidade">ğŸš€ Acessar Product Ads</a>
          </div>
        </div>
      </div>
    </section>

    <!-- BENCHMARKING -->
    <section id="tab-benchmarking" class="tab-page">
      <div class="container">
        <h1>ğŸ“Š Benchmarking</h1>
        <p class="subtitle">Em breve: compare desempenho com concorrentes.</p>
        <div class="placeholder">Sem conteÃºdo por enquanto.</div>
      </div>
    </section>

    <!-- ALERTAS -->
    <section id="tab-alertas" class="tab-page">
      <div class="container">
        <h1>ğŸš¨ Alertas</h1>
        <p class="subtitle">Em breve: notificaÃ§Ãµes de estoque, preÃ§o e performance.</p>
        <div class="placeholder">Sem conteÃºdo por enquanto.</div>
      </div>
    </section>

    <!-- ML -->
    <section id="tab-ml" class="tab-page">
      <div class="container">
        <h1>ğŸŸ¡ Mercado Livre</h1>
        <p class="subtitle">InformaÃ§Ãµes da conta e utilitÃ¡rios ML.</p>
        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ§­ Rotas & Debug <span class="status active">Ativo</span></h3>
            <p>Listagem de endpoints e verificaÃ§Ãµes rÃ¡pidas.</p>
            <a href="/debug/routes">ğŸ“Š Ver Rotas</a>
          </div>
        </div>
      </div>
    </section>

    <!-- FULL -->
    <section id="tab-full" class="tab-page">
      <div class="container">
        <h1>ğŸ“¦ FULL</h1>
        <p class="subtitle">Produtos que estÃ£o no fulfillment do Mercado Livre (ML Full).</p>

        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ—‚ï¸ Produtos (Full) <span id="full-status-pill" class="status active">Ativo</span></h3>
            <p>Veja os itens que estÃ£o no centro de fulfillment (estoque, preÃ§o, status, promoÃ§Ãµes ativas).</p>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="mini-stat">
                <strong id="full-total-itens">â€”</strong>
                <small>itens em Full</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-ativos">â€”</strong>
                <small>ativos</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-transf">â€”</strong>
                <small>em transferÃªncia</small>
              </span>
              <span class="mini-stat">
                <strong id="full-total-ineleg">â€”</strong>
                <small>inelegÃ­veis</small>
              </span>
            </div>
            <div style="margin-top:12px;">
              <a class="btn-primary" href="/full">ğŸš€ Abrir Produtos (Full)</a>
            </div>
          </div>

          <div class="endpoint">
            <h3>ğŸ“¤ ExportaÃ§Ãµes</h3>
            <p>Gere relatÃ³rios CSV/XLSX dos itens sob Full. (Na pÃ¡gina dedicada, use â€œExportar CSVâ€.)</p>
            <a href="/full">ğŸ“„ Ir para Exportar</a>
          </div>
        </div>

        <div class="placeholder" id="full-hint" style="display:none; margin-top:8px;">
          â„¹ï¸ Dica: caso os totais nÃ£o carreguem, finalize a configuraÃ§Ã£o do endpoint <code>GET /api/full/summary</code>.
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="tab-page">
      <div class="container">
        <h1>ğŸ›¡ï¸ Admin</h1>
        <p class="subtitle">Acesso restrito a administradores.</p>

        <div class="endpoints">
          <div class="endpoint">
            <h3>ğŸ‘¥ Gerenciar <span class="status active">Ativo</span></h3>
            <p>Crie, edite, remova e gerencie o sistema.</p>
            <a href="/admin/usuarios">ğŸ‘¥ Gerenciar Sistema</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal de Status (token) -->
  <div id="modal-status" class="modal">
    <div class="modal-content">
      <div class="modal-header alt">
        <h3>ğŸŸ¢ Status da IntegraÃ§Ã£o</h3>
        <span class="close" onclick="fecharModalStatus()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="status-grid">
          <div class="stat-mini"><h4 id="status-usuario">â€”</h4><p>UsuÃ¡rio</p></div>
          <div class="stat-mini"><h4 id="status-token">â€”</h4><p>Token (preview)</p></div>
          <div class="stat-mini"><h4 id="status-msg">â€”</h4><p>Mensagem</p></div>
        </div>
        <div class="modal-controls">
          <button class="btn-small btn-primary" onclick="verificarToken(true)">ğŸ” Verificar</button>
          <button class="btn-small btn-success" onclick="renovarToken(true)">ğŸ”„ Renovar</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ===== Util ===== */
  const $ = (id) => document.getElementById(id);
  const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));

  function safeBind(el, ev, fn) { if (el) el.addEventListener(ev, fn); }
  function show(el) { if (el) el.style.display = 'block'; }
  function hide(el) { if (el) el.style.display = 'none'; }
  function safeAlert(msg) { try { alert(msg); } catch(_) { console.log('ALERT:', msg); } }

  const fmtBRL = (v) => {
    const n = Number(v || 0);
    try {
      return new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' }).format(n);
    } catch(_) {
      return 'R$ ' + n.toFixed(2);
    }
  };

  const fmtNum = (v) => {
    const n = Number(v || 0);
    try { return new Intl.NumberFormat('pt-BR').format(n); } catch(_) { return String(n); }
  };

  function showDashAlert(type, text){
    const el = $('dash-alert');
    if (!el) return;
    el.className = '';
    el.style.display = 'block';
    el.classList.add('dash-alert', type === 'error' ? 'dash-alert--error' : 'dash-alert--info');
    el.textContent = text;
  }
  function hideDashAlert(){
    const el = $('dash-alert');
    if (!el) return;
    el.style.display = 'none';
    el.textContent = '';
    el.className = '';
  }

  /* ===== Abas (salva hash + lÃª hash) ===== */
  function initTabs() {
    const tabs = qsa('.nav-tab');
    const pages = qsa('.tab-page');

    tabs.forEach(btn => {
      safeBind(btn, 'click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        pages.forEach(p => p.classList.remove('active'));

        btn.classList.add('active');
        const id = 'tab-' + btn.dataset.tab;
        const page = $(id);
        if (page) page.classList.add('active');

        if (btn.dataset.tab) history.replaceState(null, '', '#' + btn.dataset.tab);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  }

  function openTabByHash() {
    const hash = (location.hash || '').replace('#', '').trim();
    if (!hash) return;
    const btn = document.querySelector(`.nav-tab[data-tab="${hash}"]`);
    if (btn) btn.click();
  }

  /* ===== Conta / Trocar conta ===== */
  const ACCOUNT_LABELS = {
    drossi: 'DRossi Interiores',
    diplany: 'Diplany',
    rossidecor: 'Rossi Decor'
  };

  async function carregarContaAtual() {
    const currentEl = $('account-current');
    const inlineEl  = $('account-name-inline');
    try {
      const r = await fetch('/api/account/current', { cache: 'no-store' });
      const data = await r.json();
      let shown = 'NÃ£o selecionada';
      if (data && (data.ok || data.success)) {
        shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
      }
      if (currentEl) currentEl.textContent = shown;
      if (inlineEl)  inlineEl.textContent  = shown;
    } catch(e) {
      if (currentEl) currentEl.textContent = 'IndisponÃ­vel';
      if (inlineEl)  inlineEl.textContent  = 'IndisponÃ­vel';
      console.error('carregarContaAtual:', e);
    }
  }

  async function trocarConta() {
    try { await fetch('/api/account/clear', { method: 'POST' }); } catch (_) {}
    window.location.href = '/select-conta';
  }

  /* ===== Token / Status ===== */
  function abrirModalStatus() { show($('modal-status')); }
  function fecharModalStatus() { hide($('modal-status')); }

  async function verificarToken(updateModal=false) {
    try {
      const response = await fetch('/verificar-token');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data.success) {
        if (updateModal) {
          const u = $('status-usuario'), t = $('status-token'), m = $('status-msg');
          if (u) u.textContent = data.nickname || 'â€”';
          if (t) t.textContent = data.token_preview || 'â€”';
          if (m) m.textContent = data.message || 'OK';
        } else {
          safeAlert('âœ… ' + (data.message || 'OK') +
            '\nUser: ' + (data.nickname || 'â€”') +
            '\nToken: ' + (data.token_preview || 'â€”'));
        }
      } else {
        const msg = data.error || 'Falha ao verificar';
        if (updateModal) {
          const m = $('status-msg'); if (m) m.textContent = msg;
        } else {
          safeAlert('âŒ ' + msg);
        }
      }
    } catch (error) {
      if (updateModal) {
        const m = $('status-msg'); if (m) m.textContent = 'Erro: ' + error.message;
      } else {
        safeAlert('âŒ Erro: ' + error.message);
      }
    }
  }

  async function renovarToken(updateModal=false) {
    try {
      const response = await fetch('/renovar-token-automatico', { method: 'POST' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data.success) {
        if (updateModal) {
          const u = $('status-usuario'), t = $('status-token'), m = $('status-msg');
          if (u) u.textContent = data.nickname || 'â€”';
          if (t) t.textContent = (data.access_token || '').substring(0, 20) + '...';
          if (m) m.textContent = data.message || 'Token renovado';
        } else {
          safeAlert('âœ… ' + (data.message || 'Token renovado') +
            '\nUser: ' + (data.nickname || 'â€”') +
            '\nNovo token: ' + (data.access_token || '').substring(0, 20) + '...');
        }
      } else {
        const msg = data.error || 'Falha ao renovar';
        if (updateModal) {
          const m = $('status-msg'); if (m) m.textContent = msg;
        } else {
          safeAlert('âŒ ' + msg);
        }
      }
    } catch (error) {
      if (updateModal) {
        const m = $('status-msg'); if (m) m.textContent = 'Erro: ' + error.message;
      } else {
        safeAlert('âŒ Erro: ' + error.message);
      }
    }
  }

  /* ===== Dashboard (novo) ===== */
  function setText(id, v){ const el = $(id); if (el) el.textContent = v; }

  function renderSparkline(dailyOrders, dayOfMonth, daysInMonth) {
    const wrap = $('dash-sparkline');
    const empty = $('dash-spark-empty');
    if (!wrap) return;

    wrap.innerHTML = '';

    const arr = Array.isArray(dailyOrders) ? dailyOrders : [];
    if (!arr.length) {
      if (empty) empty.style.display = 'block';
      return;
    }
    if (empty) empty.style.display = 'none';

    const max = Math.max(1, ...arr.map(x => Number(x.revenue || 0)));

    for (let i = 0; i < arr.length; i++) {
      const d = arr[i];
      const value = Number(d.revenue || 0);
      const pct = Math.max(0.04, value / max); // mÃ­nimo visual
      const bar = document.createElement('div');
      bar.className = 'spark-bar';

      const dayIndex = i + 1;

      if (dayIndex > dayOfMonth) bar.classList.add('is-future');
      if (dayIndex === dayOfMonth) bar.classList.add('is-today');

      bar.style.height = Math.round(pct * 100) + '%';
      bar.title = `${d.date}\nVendas: ${fmtBRL(value)}\nPedidos: ${fmtNum(d.orders || 0)}\nUnidades: ${fmtNum(d.units || 0)}`;

      wrap.appendChild(bar);
    }

    const fill = $('dash-progress-fill');
    const meta = $('dash-progress-meta');
    const progress = Math.min(100, Math.max(0, (dayOfMonth / daysInMonth) * 100));
    if (fill) fill.style.width = progress.toFixed(2) + '%';
    if (meta) meta.textContent = `Dia ${dayOfMonth} de ${daysInMonth} (${progress.toFixed(0)}% do mÃªs)`;
  }

  async function carregarDashboard() {
    hideDashAlert();

    try {
      const r = await fetch('/api/dashboard/monthly-sales?tz=America%2FSao_Paulo', { cache: 'no-store' });
      const data = await r.json();
      if (!r.ok || !data || !data.ok) {
        throw new Error((data && data.error) ? data.error : `HTTP ${r.status}`);
      }

      const period = data.period || {};
      const totals = data.totals || {};
      const breakdown = data.breakdown || {};
      const ads = data.ads || {};
      const series = data.series || {};

      const month = String(period.month || '').padStart(2,'0');
      setText('dash-period', `${period.year}-${month}`);
      setText('dash-day', `${period.day_of_month}/${period.days_in_month}`);

      setText('dash-total', fmtBRL(breakdown.total_all || totals.revenue_month_to_date || 0));
      setText('dash-projected', fmtBRL(totals.revenue_projected_month || 0));
      setText('dash-avg', fmtBRL(totals.avg_daily_revenue || 0));

      // Ads
      if (ads.available) {
        setText('dash-ads', fmtBRL(breakdown.ads_direct_amount || 0));
        setText('dash-ads-pill', 'ok');
      } else {
        setText('dash-ads', fmtBRL(0));
        setText('dash-ads-pill', 'indisp.');
      }

      setText('dash-organic', fmtBRL(breakdown.organic_estimated || 0));

      setText('dash-orders', fmtNum(totals.orders_count || 0));
      setText('dash-units', fmtNum(totals.units_sold || 0));
      setText('dash-ticket', fmtBRL(totals.ticket_medio || 0));

      const hint = `Ex: (${fmtBRL(totals.revenue_month_to_date || 0)} Ã· ${period.day_of_month || 1}) Ã— ${period.days_in_month || 30}`;
      setText('dash-formula-hint', hint);

      renderSparkline(series.daily_orders || [], period.day_of_month || 1, period.days_in_month || 30);

      if (!ads.available && ads.error) {
        showDashAlert('info', `â„¹ï¸ Ads: ${ads.error}`);
      }
    } catch (e) {
      console.error('carregarDashboard:', e);
      showDashAlert('error', 'âŒ NÃ£o foi possÃ­vel carregar o dashboard: ' + (e.message || String(e)));
    }
  }

  /* ===== Bind global (para onclick no HTML) ===== */
  Object.assign(window, {
    abrirModalStatus,
    fecharModalStatus,
    verificarToken,
    renovarToken,
    trocarConta
  });

  /* ===== Listeners estÃ¡ticos ===== */
  function bindStaticListeners() {
    safeBind($('btn-status'), 'click', async () => {
      abrirModalStatus();
      await verificarToken(true);
    });
    safeBind($('account-switch'), 'click', trocarConta);

    safeBind($('dash-refresh'), 'click', carregarDashboard);

    window.addEventListener('hashchange', openTabByHash);

    // Fechar modal ao clicar fora
    window.addEventListener('click', (event) => {
      const m = $('modal-status');
      if (event.target === m) fecharModalStatus();
    });
  }

  /* ===== Boot ===== */
  document.addEventListener('DOMContentLoaded', () => {
    try {
      initTabs();
      bindStaticListeners();
      carregarContaAtual();
      openTabByHash();
      if (!location.hash) history.replaceState(null, '', '#dashboard');

      // Carrega dashboard assim que abre
      carregarDashboard();
    } catch (e) {
      console.error('Erro na inicializaÃ§Ã£o:', e);
    }
  });
})();
</script>
</body>
</html>
