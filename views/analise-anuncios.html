<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="/css/dashboard.css">
  <link href="/css/analise-anuncio.css" rel="stylesheet"/>
  <title>An√°lise de An√∫ncios</title>
</head>
<body>

  <header class="account-bar">
    <div class="account-bar__left">
      <span class="logo">üü°</span>
      <span class="app-name">API Mercado Livre</span>
    </div>
    <div class="account-bar__right">
      <div class="account-bar__current">
        <span class="lbl">Conta:</span>
        <span id="account-current" class="val">Carregando...</span>
      </div>
      <button id="btn-status" class="account-bar__status" title="Ver status do token">Status</button>
      <button id="account-switch" class="account-bar__switch" title="Trocar de conta">Trocar Conta</button>
    </div>
  </header>

  <nav class="main-nav">
    <div class="tabs">
      <a class="nav-tab" data-tab="dashboard" href="/dashboard">Dashboard</a>
      <a class="nav-tab" data-tab="produtos" href="/criar-promocao">Produtos</a>
      <a class="nav-tab" data-tab="ia" href="/analise-anuncios">IA &amp; Analytics</a>
      <a class="nav-tab" data-tab="benchmarking" href="/benchmarking">Benchmarking</a>
      <a class="nav-tab" data-tab="alertas" href="/alertas">Alertas</a>
      <a class="nav-tab" data-tab="ml" href="/debug/routes">ML</a>
    </div>
  </nav>
    

  <div id="modal-status" class="modal">
    <div class="modal-content">
      <div class="modal-header alt">
        <h3>üü¢ Status da Integra√ß√£o</h3>
        <span class="close" onclick="fecharModalStatus()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="status-grid">
          <div class="stat-mini"><h4 id="status-usuario">‚Äî</h4><p>Usu√°rio</p></div>
          <div class="stat-mini"><h4 id="status-token">‚Äî</h4><p>Token (preview)</p></div>
          <div class="stat-mini"><h4 id="status-msg">‚Äî</h4><p>Mensagem</p></div>
        </div>
        <div class="modal-controls">
          <button class="btn-small btn-primary" onclick="verificarToken(true)">üîç Verificar</button>
          <button class="btn-small btn-success" onclick="renovarToken(true)">üîÑ Renovar</button>
        </div>
      </div>
    </div>
  </div>
    
<main class="page-wrap">
  <section class="tab-page active">
    <div class="container">

<!-- Barra fixa de conta (igual ao dashboard) -->

<main class="container">
<h1>üìà An√°lise de An√∫ncios (MLB)</h1>
<p class="sub">
      Informe um MLB (unit√°rio) ou cole uma lista para an√°lise em massa. Apenas itens da
      <strong>conta selecionada</strong> ser√£o considerados.
    </p>
<section class="inputs">
<div class="card">
<h3>üî∏ MLB √∫nico</h3>
<div class="row">
<input id="mlb-single" placeholder="Ex.: MLB1234567890" type="text"/>
<button class="btn btn-primary" id="btn-analisar-um">Analisar</button>
</div>
</div>
<div class="card">
<h3>üß± Lote de MLBs</h3>
<textarea id="mlb-bulk" placeholder="Cole um MLB por linha" rows="8"></textarea>
<div class="row">
<label class="lbl-sm">
            Intervalo entre requisi√ß√µes:
            <input id="delay-ms" min="0" type="number" value="300"/> ms
          </label>
<button class="btn btn-success" id="btn-analisar-lote">Iniciar Lote</button>
</div>
<div class="progress">
<div class="progress__fill" id="progress-bar" style="width:0%"></div>
</div>
<div class="progress__text">
<span id="progress-text">0 / 0</span>
</div>
</div>
</section>
<section class="results card">
<div class="results__header">
<h3>Resultados</h3>
<button class="btn btn-secondary" disabled="" id="btn-download">‚¨áÔ∏è Baixar (XLSX/CSV)</button>
</div>
<div class="table-wrap">
<table class="table" id="results-table">
<thead>
<tr>
<th>#</th>
<th>MLB</th>
<th>Tipo</th>
<th>Data cria√ß√£o</th>
<th>√öltima venda</th>
<th>Tempo desde a √∫ltima venda</th>
<th>Vendas 30d</th>
<th>Vendas 60d</th>
<th>Vendas 90d</th>
<th>Receita 30d</th>
<th>Receita 60d</th>
<th>Receita 90d</th>
<th>Tempo m√©dio entre vendas</th>
<th>Ads 30d</th>
<th>Ads 60d</th>
<th>Ads 90d</th>
<th>Status</th>
</tr>
</thead>
<tbody id="results-body">
<tr><td colspan="16" style="text-align:center;color:#6b7280;">Sem resultados ainda</td></tr>
</tbody>
</table>
</div>
</section>
</main>
<script src="/js/analise-anuncio.js"></script>
<script>
    // Conta atual + Trocar conta
    async function carregarContaAtual() {
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        const label = data?.label || data?.accountKey || 'Indefinida';
        document.getElementById('account-current').textContent = label;
      } catch { document.getElementById('account-current').textContent = 'Indispon√≠vel'; }
    }
    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        location.href = '/select-conta';
      } catch { location.href = '/select-conta'; }
    }
    document.addEventListener('DOMContentLoaded', () => {
      carregarContaAtual();
      document.getElementById('account-switch').addEventListener('click', trocarConta);
    });
  </script>

    </div>
  </section>
</main>

  <script>
    // Marcar aba ativa
    (function() {
      var tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(function(t) {
        if (t.getAttribute('data-tab') === 'ia') t.classList.add('active');
      });
    })();

    // Conta atual + Trocar conta
    const ACCOUNT_LABELS = { drossi: 'DRossi Interiores', diplany: 'Diplany', rossidecor: 'Rossi Decor' };
    async function carregarContaAtual() {
      const currentEl = document.getElementById('account-current');
      try {
        const r = await fetch('/api/account/current', { cache: 'no-store' });
        const data = await r.json();
        let shown = 'N√£o selecionada';
        if (data && (data.ok || data.success)) {
          shown = data.label || ACCOUNT_LABELS[data.accountKey] || data.accountKey || 'Desconhecida';
        } else if (data) {
          shown = data.label || data.accountKey || 'Desconhecida';
        }
        currentEl.textContent = shown;
      } catch(e) {
        currentEl.textContent = 'Indispon√≠vel';
      }
    }
    async function trocarConta() {
      try {
        await fetch('/api/account/clear', { method: 'POST' });
        window.location.href = '/select-conta';
      } catch(e) {
        window.location.href = '/select-conta';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      carregarContaAtual();
      var switchBtn = document.getElementById('account-switch');
      if (switchBtn) switchBtn.addEventListener('click', trocarConta);
    });

    // Status (token)
    function abrirModalStatus() {
      document.getElementById('modal-status').style.display = 'block';
    }
    function fecharModalStatus() {
      document.getElementById('modal-status').style.display = 'none';
    }
    document.getElementById('btn-status').addEventListener('click', async () => {
      abrirModalStatus();
      await verificarToken(true);
    });
    async function verificarToken(updateModal=false) {
      try {
        const response = await fetch('/verificar-token');
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '‚Äî';
            document.getElementById('status-token').textContent = data.token_preview || '‚Äî';
            document.getElementById('status-msg').textContent = data.message || 'OK';
          } else {
            alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nToken: ' + data.token_preview);
          }
        } else {
          if (updateModal) {
            document.getElementById('status-msg').textContent = data.error || 'Falha ao verificar';
          } else {
            alert('‚ùå ' + (data.error || 'Falha ao verificar'));
          }
        }
      } catch (error) {
        if (updateModal) document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        else alert('‚ùå Erro: ' + error.message);
      }
    }
    async function renovarToken(updateModal=false) {
      try {
        const response = await fetch('/renovar-token-automatico', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          if (updateModal) {
            document.getElementById('status-usuario').textContent = data.nickname || '‚Äî';
            document.getElementById('status-token').textContent = (data.access_token || '').substring(0, 20) + '...';
            document.getElementById('status-msg').textContent = data.message || 'Token renovado';
          } else {
            alert('‚úÖ ' + data.message + '\nUser: ' + data.nickname + '\nNovo token: ' + data.access_token.substring(0, 20) + '...');
          }
        } else {
          if (updateModal) document.getElementById('status-msg').textContent = data.error || 'Falha ao renovar';
          else alert('‚ùå ' + (data.error || 'Falha ao renovar'));
        }
      } catch (error) {
        if (updateModal) document.getElementById('status-msg').textContent = 'Erro: ' + error.message;
        else alert('‚ùå Erro: ' + error.message);
      }
    }
    // Fechar modal clicando fora
    window.addEventListener('click', function(event){
      const m2 = document.getElementById('modal-status');
      if (event.target === m2) fecharModalStatus();
    });
  </script>
    
</body>
</html>